/*
 * $Id: browse_encoder.c,v 1.3 2010/09/01 16:05:22 philipn Exp $
 *
 * MPEG-2 encodes planar YUV420 video and 16-bit PCM audio
 *
 * Copyright (C) 2007 BBC Research, Stuart Cunningham <stuart_hc@users.sourceforge.net>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */

/*
    The browse copy MPEG-2 file is created at the same time as the raw 
    uncompressed data is captured from SDI. The input to the encoder is planar 
    YUV 4:2:0 video plus 2 channels of interleaved 16-bit audio data.
    
    The encoder parameters set in add_video_stream() have been chosen to support 
    realtime encoding in the Ingex Archive recorder.
    
    The input VITC and LTC parameters to the browse_encoder_encode() are 
    currently unused. Code is included to burn these timecodes into the picture.
*/


#include <string.h>
#include <stdlib.h>

#ifdef FFMPEG_OLD_INCLUDE_PATHS
#include <ffmpeg/avcodec.h>
#include <ffmpeg/avformat.h>
#else
#include <libavcodec/avcodec.h>
#include <libavformat/avformat.h>
#endif

#include "browse_encoder.h"


#define MPA_FRAME_SIZE 1152

#if 0 // not used
static unsigned char tc_colon[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x05,0xA6,0xFC,0xFC,0xA3,0x00,0x00,
0x00,0x00,0x06,0xA8,0xFF,0xFF,0xA5,0x00,0x00,
0x00,0x00,0x06,0xA8,0xFF,0xFF,0xA5,0x00,0x00,
0x00,0x00,0x06,0xA8,0xFF,0xFF,0xA5,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x05,0xA6,0xFC,0xFC,0xA3,0x00,0x00,
0x00,0x00,0x06,0xA8,0xFF,0xFF,0xA5,0x00,0x00,
0x00,0x00,0x06,0xA8,0xFF,0xFF,0xA5,0x00,0x00,
0x00,0x00,0x06,0xA8,0xFF,0xFF,0xA5,0x00,0x00,
};

static unsigned char tc_digit[10][18*24] = {
{
0x00,0x00,0x00,0x00,0x00,0x2E,0x99,0xDB,0xF9,0xF9,0xDA,0x99,0x2E,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x81,0xFD,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0x7F,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x80,0xFF,0xFF,0xFF,0xBB,0x7E,0x7F,0xBD,0xFF,0xFF,0xFF,0x7C,0x00,0x00,0x00,
0x00,0x00,0x35,0xFD,0xFF,0xFA,0x50,0x00,0x00,0x00,0x00,0x53,0xFB,0xFF,0xFD,0x31,0x00,0x00,
0x00,0x00,0xB6,0xFF,0xFF,0x79,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0xFF,0xFF,0xB2,0x00,0x00,
0x00,0x1B,0xFD,0xFF,0xEF,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0xF1,0xFF,0xFD,0x19,0x00,
0x00,0x64,0xFF,0xFF,0xA3,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xA6,0xFF,0xFF,0x62,0x00,
0x00,0x9E,0xFF,0xFF,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x69,0xFF,0xFF,0x9B,0x00,
0x00,0xC7,0xFF,0xFF,0x3D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0xFF,0xFF,0xC5,0x00,
0x00,0xE4,0xFF,0xFF,0x21,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x23,0xFF,0xFF,0xE2,0x00,
0x00,0xF5,0xFF,0xFF,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x12,0xFF,0xFF,0xF4,0x00,
0x00,0xFD,0xFF,0xFF,0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0B,0xFF,0xFF,0xFC,0x00,
0x00,0xFD,0xFF,0xFF,0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0A,0xFF,0xFF,0xFC,0x00,
0x00,0xF5,0xFF,0xFF,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0xFF,0xFF,0xF4,0x00,
0x00,0xE4,0xFF,0xFF,0x21,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x22,0xFF,0xFF,0xE2,0x00,
0x00,0xC8,0xFF,0xFF,0x3D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3E,0xFF,0xFF,0xC5,0x00,
0x00,0x9E,0xFF,0xFF,0x66,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x68,0xFF,0xFF,0x9C,0x00,
0x00,0x65,0xFF,0xFF,0xA2,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xA5,0xFF,0xFF,0x63,0x00,
0x00,0x1C,0xFE,0xFF,0xEE,0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x0B,0xF1,0xFF,0xFD,0x19,0x00,
0x00,0x00,0xB7,0xFF,0xFF,0x77,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0xFF,0xFF,0xB3,0x00,0x00,
0x00,0x00,0x35,0xFE,0xFF,0xF9,0x4E,0x00,0x00,0x00,0x00,0x51,0xFA,0xFF,0xFD,0x32,0x00,0x00,
0x00,0x00,0x00,0x81,0xFF,0xFF,0xFF,0xB9,0x7D,0x7E,0xBB,0xFF,0xFF,0xFF,0x7C,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x83,0xFD,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFD,0x80,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x2F,0x9C,0xDC,0xF9,0xF9,0xDC,0x9B,0x2F,0x00,0x00,0x00,0x00,0x00,
},
{
0x00,0x00,0x00,0x0E,0x43,0x7B,0xB2,0xE9,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x88,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x08,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x9C,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x08,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x9C,0xEF,0xBB,0x86,0x50,0x1B,0xFF,0xFF,
0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x11,0x01,0x00,0x00,0x00,0x00,
0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,
0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,
0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x74,0x74,0x74,
0x74,0x74,0xFF,0xFF,0xFF,0x78,0x74,0x74,0x74,0x74,0x2F,0x00,0x00,0x00,0x08,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x68,0x00,0x00,0x00,
0x08,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x68,0x00,
},
{
0x00,0x00,0x01,0x37,0x7D,0xB5,0xE1,0xF7,0xF7,0xE4,0xB5,0x6F,0x0F,0x00,0x00,0x00,
0x00,0x00,0x00,0x64,0xE2,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x5C,
0x00,0x00,0x00,0x00,0x00,0xA8,0xFF,0xFF,0xFF,0xD5,0x9D,0x7D,0x7B,0x9D,0xE9,0xFF,
0xFF,0xFF,0x75,0x00,0x00,0x00,0x00,0xA8,0xF0,0x89,0x25,0x00,0x00,0x00,0x00,0x00,
0x08,0x96,0xFF,0xFF,0xFC,0x30,0x00,0x00,0x00,0x48,0x0F,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xB0,0xFF,0xFF,0xA0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x39,0xFF,0xFF,0xE1,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xFF,0xFF,0xFB,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,0xFF,0xFF,0xF4,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x63,0xFF,0xFF,0xCB,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0xD9,0xFF,
0xFF,0x79,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x8B,
0xFF,0xFF,0xEE,0x11,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x57,0xFF,0xFF,0xFF,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x3F,0xF7,0xFF,0xFF,0xA5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x37,0xF2,0xFF,0xFF,0xBC,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x32,0xEF,0xFF,0xFF,0xC7,0x0B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x30,0xED,0xFF,0xFF,0xD0,0x10,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x2E,0xEC,0xFF,0xFF,0xD7,0x15,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x2C,0xEB,0xFF,0xFF,0xDD,0x1A,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2B,0xEA,0xFF,0xFF,0xE2,0x20,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0xE8,0xFF,0xFF,0xE7,0x25,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x25,0xE6,0xFF,0xFF,0xEB,0x2A,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC6,0xFF,0xFF,0xFF,0xA3,
0x74,0x74,0x74,0x74,0x74,0x74,0x74,0x74,0x74,0x74,0x00,0x00,0x00,0xD0,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xD0,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
},
{
0x00,0x00,0x24,0x63,0x96,0xC2,0xE3,0xF6,0xFB,0xED,0xCC,0x92,0x34,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xA8,
0x10,0x00,0x00,0x00,0x00,0x00,0xF8,0xFF,0xEE,0xB9,0x91,0x7D,0x7A,0x93,0xD3,0xFF,
0xFF,0xFF,0xCC,0x08,0x00,0x00,0x00,0x00,0x7A,0x30,0x01,0x00,0x00,0x00,0x00,0x00,
0x00,0x54,0xF6,0xFF,0xFF,0x7A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x6E,0xFF,0xFF,0xD6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x17,0xFF,0xFF,0xFD,0x02,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xFF,0xFF,0xFC,0x01,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x31,0xFF,0xFF,0xD1,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0xB6,0xFF,0xFF,0x6B,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x19,0x54,0xC9,0xFF,0xFF,
0xAE,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xA4,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xDE,0x6C,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xA4,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFE,0xC0,0x67,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x4A,0x74,0x74,
0x78,0x8B,0xBD,0xFC,0xFF,0xFF,0xD6,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x1D,0xB7,0xFF,0xFF,0xE1,0x11,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0xC3,0xFF,0xFF,0x85,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x44,0xFF,0xFF,0xD7,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0xFF,0xFF,
0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x16,
0xFF,0xFF,0xF6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x4E,0xFF,0xFF,0xD2,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x08,0xCC,0xFF,0xFF,0x87,0x00,0x00,0x93,0x76,0x1A,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x2B,0xC3,0xFF,0xFF,0xEF,0x18,0x00,0x00,0xAC,0xFF,0xFE,0xD0,0xA1,
0x84,0x77,0x7E,0x97,0xCD,0xFF,0xFF,0xFF,0xF7,0x48,0x00,0x00,0x00,0xA8,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xCC,0x32,0x00,0x00,0x00,0x00,0x04,
0x3E,0x80,0xB5,0xDA,0xF2,0xFD,0xFA,0xE8,0xC6,0x8F,0x3F,0x00,0x00,0x00,0x00,0x00,
},
{
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3A,0xFE,0xFF,0xFF,0xFF,0x08,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0xD4,0xFF,0xFF,0xFF,0xFF,
0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0xFF,0xFE,0xFF,
0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x25,0xF7,0xFF,
0x9E,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xBE,
0xFF,0xED,0x14,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x61,0xFF,0xFF,0x65,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x15,0xED,0xFF,0xC7,0x01,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xA4,0xFF,0xFC,0x30,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x46,0xFF,0xFF,0x90,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,
0x00,0x00,0x00,0x00,0x00,0x09,0xDD,0xFF,0xE5,0x0D,0x00,0x00,0x00,0xFF,0xFF,0xFF,
0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x89,0xFF,0xFF,0x57,0x00,0x00,0x00,0x00,0xFF,
0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x2E,0xFB,0xFF,0xBA,0x00,0x00,0x00,0x00,
0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x02,0xC9,0xFF,0xF8,0x25,0x00,0x00,
0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x6E,0xFF,0xFF,0x82,0x00,
0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x1C,0xF2,0xFF,0xDD,
0x08,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x83,0xFF,
0xFF,0x5D,0x14,0x14,0x14,0x14,0x14,0x14,0x14,0xFF,0xFF,0xFF,0x1B,0x14,0x14,0x07,
0x88,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0x5C,0x88,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0x5C,0x33,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0xFF,
0xFF,0xFF,0x65,0x60,0x60,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,
},
{
0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x88,0x00,
0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0x88,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x78,0x74,0x74,0x74,0x74,0x74,0x74,
0x74,0x74,0x3D,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0x08,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,
0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xFF,0xFF,0xFF,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xFF,0xFF,0xFF,0x1E,0x4A,0x60,0x5B,0x40,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0xBB,0x3F,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0x8C,0x01,0x00,0x00,0x00,0x00,0x00,0xF4,0xA6,0x60,0x31,0x19,0x17,0x30,0x6E,
0xD9,0xFF,0xFF,0xFF,0x84,0x00,0x00,0x00,0x00,0x00,0x0D,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x06,0x9C,0xFF,0xFF,0xFC,0x2C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x02,0xC3,0xFF,0xFF,0x97,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x4C,0xFF,0xFF,0xDA,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0xFF,0xFF,0xFC,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0xFF,0xFF,0xFF,
0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x22,0xFF,
0xFF,0xF3,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x71,0xFF,0xFF,0xC5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x1E,0xEA,0xFF,0xFF,0x73,0x00,0x00,0x00,0xB7,0x4A,0x05,0x00,0x00,0x00,0x00,
0x00,0x00,0x3F,0xDF,0xFF,0xFF,0xE4,0x0D,0x00,0x00,0x00,0xFC,0xFF,0xF0,0xB9,0x8F,
0x7C,0x7A,0x92,0xD0,0xFF,0xFF,0xFF,0xF3,0x39,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xCD,0x2D,0x00,0x00,0x00,0x00,0x00,0x30,
0x71,0xA5,0xCE,0xEB,0xFA,0xFD,0xEF,0xCF,0x99,0x46,0x01,0x00,0x00,0x00,0x00,0x00,
},
{
0x00,0x00,0x00,0x00,0x00,0x00,0x1C,0x7E,0xC4,0xEC,0xFC,0xF4,0xD7,0xA8,0x67,0x16,
0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x7C,0xF7,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0x8C,0x00,0x00,0x00,0x00,0x00,0x03,0xA9,0xFF,0xFF,0xFF,0xC8,0x8C,0x77,0x82,
0xA9,0xE6,0xFF,0x8C,0x00,0x00,0x00,0x00,0x00,0x8D,0xFF,0xFF,0xDA,0x37,0x00,0x00,
0x00,0x00,0x00,0x01,0x3F,0x51,0x00,0x00,0x00,0x00,0x3A,0xFE,0xFF,0xE2,0x17,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xBE,0xFF,0xFF,0x4C,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x25,0xFF,0xFF,
0xD4,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x74,
0xFF,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xAF,0xFF,0xFF,0x42,0x00,0x01,0x33,0x63,0x70,0x61,0x37,0x03,0x00,0x00,0x00,
0x00,0x00,0x00,0xD7,0xFF,0xFF,0x17,0x46,0xD5,0xFF,0xFF,0xFF,0xFF,0xFF,0xE8,0x74,
0x03,0x00,0x00,0x00,0x00,0xF1,0xFF,0xFA,0x69,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xBD,0x0A,0x00,0x00,0x00,0xFC,0xFF,0xFB,0xFC,0xFF,0xCA,0x4D,0x11,0x07,
0x2A,0x87,0xFA,0xFF,0xFF,0xA5,0x00,0x00,0x00,0xFD,0xFF,0xFF,0xFF,0xB8,0x06,0x00,
0x00,0x00,0x00,0x00,0x4C,0xFE,0xFF,0xFF,0x3A,0x00,0x00,0xF5,0xFF,0xFF,0xF9,0x1A,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x9F,0xFF,0xFF,0x9C,0x00,0x00,0xE2,0xFF,0xFF,
0xB8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x42,0xFF,0xFF,0xD8,0x00,0x00,0xC5,
0xFF,0xFF,0x8D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x16,0xFF,0xFF,0xF6,0x00,
0x00,0x9A,0xFF,0xFF,0x84,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0D,0xFF,0xFF,
0xFC,0x00,0x00,0x5F,0xFF,0xFF,0x9B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x25,
0xFF,0xFF,0xEB,0x00,0x00,0x16,0xFB,0xFF,0xD9,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x64,0xFF,0xFF,0xBD,0x00,0x00,0x00,0xAA,0xFF,0xFF,0x52,0x00,0x00,0x00,0x00,
0x00,0x00,0x07,0xD6,0xFF,0xFF,0x6D,0x00,0x00,0x00,0x28,0xF9,0xFF,0xEF,0x42,0x00,
0x00,0x00,0x00,0x0E,0xAF,0xFF,0xFF,0xE5,0x0C,0x00,0x00,0x00,0x00,0x6A,0xFF,0xFF,
0xFF,0xBF,0x84,0x7A,0x9C,0xEC,0xFF,0xFF,0xF9,0x40,0x00,0x00,0x00,0x00,0x00,0x00,
0x69,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE6,0x41,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x20,0x8C,0xD2,0xF5,0xFD,0xEC,0xBF,0x6F,0x0C,0x00,0x00,0x00,0x00,
},
{
0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xEE,0x00,0x00,0x00,0x74,0x74,0x74,0x74,0x74,0x74,0x74,0x74,0x74,0x74,
0x74,0xF1,0xFF,0xFF,0x95,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x2F,0xFF,0xFF,0xFF,0x35,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x8E,0xFF,0xFF,0xD4,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x04,0xE8,0xFF,0xFF,0x75,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x4B,0xFF,0xFF,0xFC,0x19,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xAA,0xFF,0xFF,0xB6,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0xF8,0xFF,0xFF,0x56,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x67,0xFF,0xFF,0xEE,
0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC6,0xFF,
0xFF,0x96,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x25,
0xFF,0xFF,0xFF,0x36,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x83,0xFF,0xFF,0xD5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x01,0xE0,0xFF,0xFF,0x76,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x41,0xFF,0xFF,0xFC,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x9F,0xFF,0xFF,0xB7,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0B,0xF3,0xFF,0xFF,0x57,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x5D,0xFF,0xFF,0xEF,0x07,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xBB,0xFF,0xFF,0x97,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,0xFD,0xFF,0xFF,
0x37,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x79,0xFF,
0xFF,0xD6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0xD7,0xFF,0xFF,0x77,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x36,0xFF,0xFF,0xFC,0x1A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x95,0xFF,0xFF,0xB7,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
},
{
0x00,0x00,0x00,0x00,0x05,0x5A,0xB0,0xE2,0xF7,0xF7,0xE2,0xB0,0x5B,0x05,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x24,0xD0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xD0,
0x23,0x00,0x00,0x00,0x00,0x00,0x10,0xE0,0xFF,0xFF,0xFB,0xAF,0x7E,0x7E,0xB1,0xFC,
0xFF,0xFF,0xE0,0x10,0x00,0x00,0x00,0x00,0x86,0xFF,0xFF,0xEF,0x33,0x00,0x00,0x00,
0x00,0x36,0xF0,0xFF,0xFF,0x85,0x00,0x00,0x00,0x00,0xD9,0xFF,0xFF,0x69,0x00,0x00,
0x00,0x00,0x00,0x00,0x6B,0xFF,0xFF,0xD8,0x00,0x00,0x00,0x01,0xFB,0xFF,0xFF,0x19,
0x00,0x00,0x00,0x00,0x00,0x00,0x1B,0xFF,0xFF,0xFB,0x01,0x00,0x00,0x01,0xFD,0xFF,
0xFF,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0xFF,0xFF,0xFC,0x01,0x00,0x00,0x00,
0xD6,0xFF,0xFF,0x19,0x00,0x00,0x00,0x00,0x00,0x00,0x1A,0xFF,0xFF,0xD4,0x00,0x00,
0x00,0x00,0x78,0xFF,0xFF,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x69,0xFF,0xFF,0x74,
0x00,0x00,0x00,0x00,0x07,0xC6,0xFF,0xED,0x30,0x00,0x00,0x00,0x00,0x33,0xEF,0xFF,
0xC4,0x05,0x00,0x00,0x00,0x00,0x00,0x0B,0x95,0xFA,0xFB,0xAE,0x7D,0x7D,0xAF,0xFC,
0xFA,0x94,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x39,0xA8,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xA8,0x39,0x00,0x00,0x00,0x00,0x00,0x00,0x0D,0xAC,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xAD,0x0D,0x00,0x00,0x00,0x04,0xC2,0xFF,0xFF,0xEF,
0x78,0x29,0x08,0x09,0x2A,0x78,0xEF,0xFF,0xFF,0xC2,0x04,0x00,0x00,0x6C,0xFF,0xFF,
0xE7,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x22,0xE8,0xFF,0xFF,0x6B,0x00,0x00,0xCA,
0xFF,0xFF,0x64,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x65,0xFF,0xFF,0xC9,0x00,
0x00,0xF6,0xFF,0xFF,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1D,0xFF,0xFF,
0xF4,0x00,0x00,0xFB,0xFF,0xFF,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,
0xFF,0xFF,0xFA,0x00,0x00,0xE1,0xFF,0xFF,0x32,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x35,0xFF,0xFF,0xE0,0x00,0x00,0xA7,0xFF,0xFF,0x9D,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xA2,0xFF,0xFF,0xA5,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0x81,0x04,0x00,
0x00,0x00,0x00,0x06,0x88,0xFF,0xFF,0xFF,0x3D,0x00,0x00,0x00,0x98,0xFF,0xFF,0xFF,
0xE5,0x9C,0x7B,0x7C,0x9D,0xE7,0xFF,0xFF,0xFF,0x94,0x00,0x00,0x00,0x00,0x02,0x80,
0xFB,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFB,0x7E,0x02,0x00,0x00,0x00,0x00,
0x00,0x00,0x1F,0x80,0xBF,0xE8,0xF8,0xF8,0xE8,0xBF,0x7F,0x1E,0x00,0x00,0x00,0x00,
},
{
0x00,0x00,0x00,0x00,0x08,0x67,0xBA,0xEA,0xFC,0xF4,0xD0,0x8A,0x20,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x34,0xDD,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF7,0x68,
0x00,0x00,0x00,0x00,0x00,0x00,0x30,0xF2,0xFF,0xFF,0xF0,0xA0,0x7C,0x86,0xC3,0xFF,
0xFF,0xFF,0x69,0x00,0x00,0x00,0x00,0x05,0xD7,0xFF,0xFF,0xBE,0x14,0x00,0x00,0x00,
0x00,0x4D,0xF5,0xFF,0xF9,0x27,0x00,0x00,0x00,0x5C,0xFF,0xFF,0xE3,0x0E,0x00,0x00,
0x00,0x00,0x00,0x00,0x62,0xFF,0xFF,0xA9,0x00,0x00,0x00,0xB0,0xFF,0xFF,0x73,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x02,0xE1,0xFF,0xFA,0x14,0x00,0x00,0xE3,0xFF,0xFF,
0x2E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x9F,0xFF,0xFF,0x5E,0x00,0x00,0xFB,
0xFF,0xFF,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x81,0xFF,0xFF,0x98,0x00,
0x00,0xFB,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xFF,0xFF,
0xC3,0x00,0x00,0xE7,0xFF,0xFF,0x2B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x9C,
0xFF,0xFF,0xE1,0x00,0x00,0xBA,0xFF,0xFF,0x6D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xDD,0xFF,0xFF,0xF3,0x00,0x00,0x6C,0xFF,0xFF,0xDC,0x0A,0x00,0x00,0x00,0x00,
0x00,0x00,0x58,0xFF,0xFF,0xFF,0xFC,0x00,0x00,0x0D,0xE9,0xFF,0xFF,0xB2,0x0D,0x00,
0x00,0x00,0x00,0x40,0xF0,0xFF,0xFF,0xFF,0xFB,0x00,0x00,0x00,0x4A,0xFC,0xFF,0xFF,
0xE9,0x93,0x6F,0x78,0xB6,0xFE,0xFF,0xDB,0xF5,0xFF,0xEF,0x00,0x00,0x00,0x00,0x50,
0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xD6,0x27,0xFE,0xFF,0xD6,0x00,0x00,0x00,
0x00,0x00,0x16,0x80,0xCF,0xF8,0xFF,0xFA,0xCC,0x70,0x07,0x2B,0xFF,0xFF,0xAD,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x09,0x02,0x00,0x00,0x00,0x64,0xFF,0xFF,
0x73,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB7,
0xFF,0xFF,0x25,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x2E,0xFE,0xFF,0xBD,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x0B,0xCE,0xFF,0xFE,0x39,0x00,0x00,0x00,0x00,0x40,0x25,0x00,0x00,0x00,0x00,
0x00,0x00,0x2A,0xCA,0xFF,0xFF,0x8D,0x00,0x00,0x00,0x00,0x00,0x90,0xFF,0xD7,0xA0,
0x80,0x76,0x89,0xC0,0xFD,0xFF,0xFF,0xAA,0x03,0x00,0x00,0x00,0x00,0x00,0x90,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,0x7E,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
0x1E,0x70,0xAE,0xDB,0xF5,0xFD,0xEE,0xC6,0x80,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,
}
};

#endif // not used

typedef struct 
{
	/* output format context */
	AVFormatContext *oc;
	/* audio stream */
	AVStream *audio_st;
	/* audio output data */
	uint8_t *audio_outbuf;
	int audio_outbuf_size;
	int audio_input_frame_size;
	int16_t *audio_inbuf;
	int audio_inbuf_size;
	int audio_inbuf_offset;
	/* video stream */
	AVStream *video_st;
	/* video output data */
	AVFrame *picture;
	AVFrame *tmp_picture;
	uint8_t *video_outbuf;
	int frame_count, video_outbuf_size;
	/* time code mask */
	uint8_t *tc_mask;
	int tc_width;
	int tc_height;
	int tc_xoffset;
	int tc_yoffset;
} internal_browse_encoder_t;

typedef struct {
	char Hours;
	char Minutes;
	char Seconds;
	char Frames;
} TimeCode;

static int initialise_tc_mask (internal_browse_encoder_t *dvd)
{
	dvd->tc_width = 199;
	dvd->tc_height = 24;
	dvd->tc_xoffset = 460;
	dvd->tc_yoffset = 30;
	//dvd->tc_yoffset = dvd->video_st->codec->height - 30;
	dvd->tc_mask = av_mallocz (dvd->tc_width* dvd->tc_height);
	return 0;
}

#if 0 // not used
static TimeCode framesToTC(int frames)
{
	TimeCode result;

	result.Frames = frames % 25;

	result.Hours = (int) (frames / (60 * 60 * 25));
	result.Minutes = (int) ((frames - (result.Hours * 60 * 60 * 25)) / (60 * 25));
	result.Seconds = (int) ((frames - (result.Hours * 60 * 60 * 25) - (result.Minutes * 60 * 25)) / 25);

	return result;
}

static void setup_tc_digit(int x_pos, int digit, unsigned char *p)
{
	int i,j;
	unsigned char *pd = tc_digit[ digit ];

	// each digit is 18x24 pixels
	for (j = 0; j < 24; j++)
		for (i = 0; i < 18; i++)
			p[j * 199 + x_pos + i] = *pd++;
}

void setup_colon(int x_pos, unsigned char *p)
{
	int i,j;
	unsigned char *pd = tc_colon;

	// the colon is 9x24 pixels
	for (j = 0; j < 24; j++)
		for (i = 0; i < 9; i++)
			p[j * 199 + x_pos + i] = *pd++;
}

static void setup_tc_mask(internal_browse_encoder_t *dvd, int frame_number)
{
	int tc_frame = frame_number % (24*60*60*25); // avoid overflow
	TimeCode timecode = framesToTC(tc_frame);

	// timecode is always HH:MM:SS:FF giving a mask 20+20+13+20+20+13+20+20+13+20+20 = 199
	// by 24 pixels high

	setup_tc_digit(0, timecode.Hours / 10, dvd->tc_mask);
	setup_tc_digit(20, timecode.Hours % 10, dvd->tc_mask);
	setup_tc_digit(53, timecode.Minutes / 10, dvd->tc_mask);
	setup_tc_digit(73, timecode.Minutes % 10, dvd->tc_mask);
	setup_tc_digit(106, timecode.Seconds / 10, dvd->tc_mask);
	setup_tc_digit(126, timecode.Seconds % 10, dvd->tc_mask);
	setup_tc_digit(159, timecode.Frames / 10, dvd->tc_mask);
	setup_tc_digit(179, timecode.Frames % 10, dvd->tc_mask);
	setup_colon(20+20+2, dvd->tc_mask);
	setup_colon(20+20+13+20+20+2, dvd->tc_mask);
	setup_colon(20+20+13+20+20+13+20+20+2, dvd->tc_mask);
}
#endif // not used

/* add a video output stream */
AVStream *add_video_stream(AVFormatContext *oc, int codec_id, int aspect_ratio_num, int aspect_ratio_den, int bit_rate, int thread_count)
{
    //Modifiying all values to dvd format values
    AVCodecContext *c;
    AVStream *st;

    oc->packet_size = 2048;
    oc->mux_rate = 10080000;
	
    st = av_new_stream(oc, 0);
    if (!st) {
        fprintf(stderr, "Could not alloc stream\n");
        return NULL;
    }
    avcodec_get_context_defaults2(st->codec, CODEC_TYPE_VIDEO);

    c = st->codec;

    st->r_frame_rate.num = 25;
    st->r_frame_rate.den = 1;
    if ((aspect_ratio_num == 4 && aspect_ratio_den == 3) ||
        (aspect_ratio_num < 1 || aspect_ratio_den < 1))
    {
        /* 4:3 or unknown and default to 4:3 */
#if LIBAVFORMAT_VERSION_INT > ((52<<16)+(20<<8)+0)
        st->sample_aspect_ratio.num = 59;
        st->sample_aspect_ratio.den = 54;
        c->sample_aspect_ratio = st->sample_aspect_ratio;
#else
        c->sample_aspect_ratio.num = 59;
        c->sample_aspect_ratio.den = 54;
#endif
    }
    else if (aspect_ratio_num == 16 && aspect_ratio_den == 9)
    {
        /* 16:9 */
#if LIBAVFORMAT_VERSION_INT > ((52<<16)+(20<<8)+0)
        st->sample_aspect_ratio.num = 118;
        st->sample_aspect_ratio.den = 81;
        c->sample_aspect_ratio = st->sample_aspect_ratio;
#else
        c->sample_aspect_ratio.num = 118;
        c->sample_aspect_ratio.den = 81;
#endif
    }
    else
    {
        fprintf(stderr, "Aspect ratio %d/%d not supported\n", aspect_ratio_num, aspect_ratio_den);
        return NULL;
    }

    c->codec_id = codec_id;
    c->codec_type = CODEC_TYPE_VIDEO;

    /* put dvd parameters */
    c->bit_rate = bit_rate * 1000;
    c->rc_max_rate = bit_rate * 1000; //9000000;
    c->rc_min_rate = bit_rate * 1000; //0
    c->rc_buffer_size = 224*1024*8;
    c->rc_initial_buffer_occupancy = c->rc_buffer_size * 3/4;

    /* parameters which were found to help the encoder cope better with difficult picture */    
    //c->max_qdiff = 10;
    //c->rc_eq = "tex^qComp";
    //c->qcompress = 0.1;
    
    /* resolution must be a multiple of two */
    c->width = 720;  
    c->height = 576;
    /* time base: this is the fundamental unit of time (in seconds) in terms
       of which frame timestamps are represented. for fixed-fps content,
       timebase should be 1/framerate and timestamp increments should be
       identically 1. */
    c->time_base.den = 25;  
    c->time_base.num = 1;
    c->gop_size = 15; /* emit one intra frame every 15 frames at most */
    c->pix_fmt = PIX_FMT_YUV420P;
    if (c->codec_id == CODEC_ID_MPEG2VIDEO) {
        /* just for testing, we also add B frames */
        c->max_b_frames = 2;
    }
    if (c->codec_id == CODEC_ID_MPEG1VIDEO){
        /* needed to avoid using macroblocks in which some coeffs overflow 
           this doesnt happen with normal video, it just happens here as the 
           motion of the chroma plane doesnt match the luma plane */
        c->mb_decision=2;
    }
    // some formats want stream headers to be seperate
    if(!strcmp(oc->oformat->name, "mp4") || !strcmp(oc->oformat->name, "mov") || !strcmp(oc->oformat->name, "3gp"))
        c->flags |= CODEC_FLAG_GLOBAL_HEADER;
    
    /* initialise the threads */
    if (thread_count > 0)
    {
        avcodec_thread_init(c, thread_count);
    }

// tests
    //c->qcompress = 0.05;
    //c->qblur = 0;
    //c->rc_max_rate = bit_rate * 1000;
    //c->rc_min_rate = bit_rate * 1000;
    //c->rc_buffer_aggressivity = 1.0;//0.25;
    //c->flags |= CODEC_FLAG_INTERLACED_DCT;

    //c->bit_rate_tolerance = c->bit_rate;
    //c->mb_decision = FF_MB_DECISION_RD;

    //c->rc_buffer_size=224*1024*8*4.0;

    //c->max_qdiff = 3;
    //c->frame_skip_cmp = FF_CMP_DCTMAX;
    
    //c->rc_override_count=0;
    //c->me_threshold= 0;
    //c->intra_dc_precision= 8 - 8;
    //c->strict_std_compliance = 0;
    
    return st;
}

static AVFrame *alloc_picture(int pix_fmt, int width, int height)
{
    AVFrame *picture;
    uint8_t *picture_buf;
    int size;
    
    picture = avcodec_alloc_frame();
    if (!picture)
        return NULL;
    size = avpicture_get_size(pix_fmt, width, height);
    picture_buf = malloc(size);
    if (!picture_buf) {
        av_free(picture);
        return NULL;
    }
    avpicture_fill((AVPicture *)picture, picture_buf, 
                   pix_fmt, width, height);
    return picture;
}

/* open the video stream */
static int open_video(internal_browse_encoder_t *dvd)
{
	AVFormatContext *oc = dvd->oc;
	AVStream *st = dvd->video_st;
    AVCodec *codec;
    AVCodecContext *c;

    c = st->codec;

    /* find the video encoder */
    codec = avcodec_find_encoder(c->codec_id);
    if (!codec) {
        fprintf(stderr, "codec not found\n");
        return -1;
    }

    /* open the codec */
    if (avcodec_open(c, codec) < 0) {
        fprintf(stderr, "could not open codec\n");
        return -1;
    }

    dvd->video_outbuf = NULL;
    if (!(oc->oformat->flags & AVFMT_RAWPICTURE)) {
        /* allocate output buffer */
        /* XXX: API change will be done */
        dvd->video_outbuf_size = 550000;
        dvd->video_outbuf = malloc(dvd->video_outbuf_size);
    }

    /* allocate the encoded raw picture */
    dvd->picture = alloc_picture(c->pix_fmt, c->width, c->height);
    if (!dvd->picture) {
        fprintf(stderr, "Could not allocate picture\n");
        return -1;
    }

	return 0;
}

static void close_video(internal_browse_encoder_t *dvd)
{
    avcodec_close(dvd->video_st->codec);
    av_free(dvd->picture->data[0]);
    av_free(dvd->picture);
    if (dvd->tmp_picture) {
        av_free(dvd->tmp_picture->data[0]);
        av_free(dvd->tmp_picture);
    }
    av_free(dvd->video_outbuf);
}

/* 
 * add an audio output stream
 */
static AVStream *add_audio_stream(AVFormatContext *oc, int codec_id)
{
    AVCodecContext *c;
    AVStream *st;

    st = av_new_stream(oc, 1);
    if (!st) {
        fprintf(stderr, "Could not alloc stream\n");
        return NULL;
    }
    avcodec_get_context_defaults2(st->codec, CODEC_TYPE_AUDIO);

    c = st->codec;
    c->codec_id = codec_id;
    c->codec_type = CODEC_TYPE_AUDIO;

    /* put sample parameters */
    c->bit_rate = 256000;
    c->sample_rate = 48000;
    c->channels = 2;
    return st;
}

/* open the audio stream */
static int open_audio(internal_browse_encoder_t *dvd)
{
	AVStream *st = dvd->audio_st;
    AVCodecContext *c;
    AVCodec *codec;

    c = st->codec;

    /* find the audio encoder */
    codec = avcodec_find_encoder(c->codec_id);
    if (!codec) {
        fprintf(stderr, "codec not found\n");
        return -1;
    }

    /* open it */
    if (avcodec_open(c, codec) < 0) {
        fprintf(stderr, "could not open codec\n");
        return -1;
    }

    dvd->audio_outbuf_size = 15000;
    dvd->audio_outbuf = malloc(dvd->audio_outbuf_size);

    dvd->audio_inbuf_size = 20000;
    dvd->audio_inbuf = malloc(dvd->audio_inbuf_size);
    /* ugly hack for PCM codecs (will be removed ASAP with new PCM
       support to compute the input frame size in samples */
    if (c->frame_size <= 1) {
        dvd->audio_input_frame_size = dvd->audio_outbuf_size / c->channels;
        switch(st->codec->codec_id) {
        case CODEC_ID_PCM_S16LE:
        case CODEC_ID_PCM_S16BE:
        case CODEC_ID_PCM_U16LE:
        case CODEC_ID_PCM_U16BE:
            dvd->audio_input_frame_size >>= 1;
            break;
        default:
            break;
        }
    } else {
        dvd->audio_input_frame_size = c->frame_size;
    }
	return 0;
}

void close_audio(internal_browse_encoder_t *dvd)
{
	AVStream *st = dvd->audio_st;
    avcodec_close(st->codec);
    
    av_free(dvd->audio_outbuf);
    av_free(dvd->audio_inbuf);
}

static void cleanup (internal_browse_encoder_t *dvd)
{
	if (dvd)
	{
		if (dvd->video_st)
			close_video(dvd);
		if (dvd->audio_st)
			close_audio(dvd);

		if (dvd->oc)
		{
			unsigned i;
			//free the streams
			for (i = 0; i < dvd->oc->nb_streams; i++)
			{
                av_freep(&dvd->oc->streams[i]->codec);
				av_freep(&dvd->oc->streams[i]);
			}
			av_free(dvd->oc);
		}
		if (dvd->tc_mask)
			av_free(dvd->tc_mask);

		av_free (dvd);
		dvd = NULL;
	}
}

extern browse_encoder_t *browse_encoder_init (const char *filename, int aspect_ratio_num, int aspect_ratio_den, uint32_t kbit_rate, int thread_count)
{
	internal_browse_encoder_t *browse;
	AVOutputFormat *fmt;

	/* register all ffmpeg codecs and formats */
	av_register_all();

	/* Check if browse format exists */
	fmt = guess_format ("vob", NULL, NULL);
	if (!fmt) {
		fprintf (stderr, "MPEG2 PS format (VOB) format not registered\n");
		return NULL;
	}

	browse = av_mallocz (sizeof(internal_browse_encoder_t));
	if (!browse) {
		fprintf (stderr, "Could not allocate encoder object\n");
		return NULL;
	}

	/* Allocate the output media context */
#if LIBAVFORMAT_VERSION_INT > ((52<<16)+(25<<8)+0)
	browse->oc = avformat_alloc_context();
#else
	browse->oc = av_alloc_format_context();
#endif
	if (!browse->oc)
	{
		cleanup(browse);
		fprintf (stderr, "Could not allocate output format context\n");
		return NULL;
	}
	browse->oc->oformat = fmt;
	snprintf (browse->oc->filename, sizeof(browse->oc->filename), "%s", filename);

	// H264, MPEG2VIDEO, MPEG1VIDEO, NONE, H263, MJPEG, MPEG4, RAWVIDEO, MSMPEG4V2, FLV1, XVID, RV40, VC1, FFH264
	// segv: H264, MPEG1VIDEO
	// SIGFPE: RAWVIDEO
	// other fail: MPEG2VIDEO, MPEG4, MSMPEG4V2
    fmt->video_codec = CODEC_ID_MPEG2VIDEO;
	fmt->audio_codec = CODEC_ID_MP2;

	/* 
	* add the audio and videostreams using the default format codecs and
	* initialise the codecs
	*/
	if (fmt->video_codec != CODEC_ID_NONE)
	{
		browse->video_st = add_video_stream(browse->oc, fmt->video_codec, aspect_ratio_num, aspect_ratio_den, kbit_rate, thread_count);
		if (!browse->video_st)
		{
			cleanup(browse);
			return NULL;
		}
	}
	if (fmt->audio_codec != CODEC_ID_NONE)
	{
		browse->audio_st = add_audio_stream(browse->oc, fmt->audio_codec);
		if (!browse->audio_st)
		{
			cleanup(browse);
			return NULL;
		}
	}

	/* Set the output parameters - must be done even if no parameters */
	if (av_set_parameters(browse->oc, NULL) < 0)
	{
		fprintf(stderr, "Invalid output format parameters\n");
		cleanup(browse);
		return NULL;
	}

    /* set preload and maximum delay to avoid vob buffer underflow errors */
    browse->oc->preload = (int)(0.5 * AV_TIME_BASE); /* 500 ms */
    browse->oc->max_delay = (int)(0.7 * AV_TIME_BASE); /* 700ms */
    browse->oc->loop_output = AVFMT_NOOUTPUTLOOP;

	/* open the audio and video codecs */
	if (open_video(browse) == -1) {
		return NULL;
	}
	if (open_audio(browse) == -1) {
		return NULL;
	}

	/*	open the output file */
	if (!(fmt->flags & AVFMT_NOFILE)) {
        if (url_fopen(&browse->oc->pb, filename, URL_WRONLY) < 0) {
			cleanup(browse);
            fprintf(stderr, "Could not open '%s'\n", filename);
            return NULL;
        }
    }

	initialise_tc_mask (browse);

	/* write stream header if any */
	av_write_header(browse->oc);

	return (browse_encoder_t *)browse;
}

static int write_audio_frame(internal_browse_encoder_t *dvd, const int16_t *p_audio)
{
	AVFormatContext *oc = dvd->oc;
	AVStream *st = dvd->audio_st;
	AVCodecContext *c;
    AVPacket pkt;
    av_init_packet(&pkt);
    
    c = st->codec;

    pkt.size= avcodec_encode_audio(c, dvd->audio_outbuf, dvd->audio_outbuf_size, p_audio);

    //static int g_frame_count = 0;

    pkt.pts= av_rescale_q(c->coded_frame->pts, c->time_base, st->time_base);
    pkt.flags |= PKT_FLAG_KEY;
    pkt.stream_index= st->index;
    pkt.data= dvd->audio_outbuf;

    /* write the compressed frame in the media file */
//    if (av_interleaved_write_frame(oc, &pkt) != 0) {
    if (av_write_frame(oc, &pkt) != 0) {
        fprintf(stderr, "Error while writing audio frame\n");
        return -1;
    }
	return 0;
}

static void fill_yuv_image (const uint8_t *p_video, AVFrame *pict, int width, int height)
{
	int chroma_size = (width * height)/4;
	const uint8_t *u_comp = p_video + (width*height);
	const uint8_t *v_comp = u_comp + (width*height)/4;
	/* Y */
	memcpy (pict->data[0], p_video, width * height);
	/* U */
	memcpy (pict->data[1], u_comp, chroma_size);
	/* V */
	memcpy (pict->data[2], v_comp, chroma_size);
}

#if 0 // not used

static unsigned char whiteU = 0x80, whiteY = 0xEB, whiteV = 0x80;

static void burn_mask_yuv420(internal_browse_encoder_t *dvd)
{
	int i,j;

    AVCodecContext *c = dvd->video_st->codec;
	int m_width = dvd->tc_width;
	int m_height = dvd->tc_height;

	uint8_t * y_comp = dvd->picture->data[0]+dvd->tc_yoffset*c->width;
	uint8_t * u_comp = dvd->picture->data[1]+(dvd->tc_yoffset*c->width/4);
	uint8_t * v_comp = dvd->picture->data[2]+(dvd->tc_yoffset*c->width/4);

	// add 2 lines of black pixels before burning the time code
	for (j = 0; j < 2; j++)
	{
		for (i = 0; i < m_width+3; i++)
		{
			int y_idx = i + dvd->tc_xoffset-2;
			int u_idx = i/2 + dvd->tc_xoffset/2-1;
			int v_idx = i/2 + dvd->tc_xoffset/2-1;
			y_comp[y_idx] = 0x00;
			if (i%2==0)
			{
				u_comp[u_idx] = 0x80;
				v_comp[v_idx] = 0x80;
			}
		}
		y_comp += c->width;
		if (j%2 == 0)
		{
			u_comp += (c->width/2);
			v_comp += (c->width/2);
		}
	}

	for (j = 0; j < m_height; j++)
	{
		// add 2 pixels of black to line before applying one line of mask
		for (i = 0; i < 2; i++)
		{
			int y_idx = i + dvd->tc_xoffset-2;
			int u_idx = i/2 + dvd->tc_xoffset/2-1;
			int v_idx = i/2 + dvd->tc_xoffset/2-1;
			y_comp[y_idx] = 0x00;
			if (i%2==0)
			{
				u_comp[u_idx] = 0x80;
				v_comp[v_idx] = 0x80;
			}
		}
		// apply one line of mask
		for (i = 0; i < m_width; i++)
		{
			unsigned char m1 = dvd->tc_mask[j*m_width+ i];
			double		r1 = m1 / 255.0;
			int y_idx = i + dvd->tc_xoffset;
			int u_idx = i/2 + dvd->tc_xoffset/2;
			int v_idx = i/2 + dvd->tc_xoffset/2;

			// make mask 'background' dark
			// if mask value is low (0x00 - 0x20) reduce Y value
			if (m1 <= 0x20) {
				y_comp[y_idx] = y_comp[y_idx] / 8;

				if ((i % 2 == 0) && (j % 2 == 0))
				{
					// Set chroma values to black (i.e. no colour)
					u_comp[u_idx] = 0x80;
					v_comp[v_idx] = 0x80;
				}
			}
			else {	// apply mask by scaling the pixel according to the mask value
				// Y
				y_comp[y_idx] = r1 * (whiteY - y_comp[y_idx]) + y_comp[y_idx];

				if ((i % 2 == 0) && (j % 2 == 0))
				{
					// U V
					u_comp[u_idx] = r1 * (whiteU - u_comp[u_idx]) + u_comp[u_idx];
					v_comp[v_idx] = r1 * (whiteV - v_comp[v_idx]) + v_comp[v_idx];
				}
			}
		}
		for (i = m_width; i < m_width+1; i++)
		{
			// add 1 pixel of black to line after applying one line of mask
			int y_idx = i + dvd->tc_xoffset;
			int u_idx = i/2 + dvd->tc_xoffset/2;
			int v_idx = i/2 + dvd->tc_xoffset/2;
			y_comp[y_idx] = 0x00;
			if (i%2==0)
			{
				u_comp[u_idx] = 0x80;
				v_comp[v_idx] = 0x80;
			}
		}
		y_comp += c->width;
		if (j%2 == 0)
		{
			u_comp += (c->width/2);
			v_comp += (c->width/2);
		}
	}
	// add two lines of black pixels after burning the time code
	for (j = 0; j < 2; j++)
	{
		for (i = 0; i < m_width+3; i++)
		{
			int y_idx = i + dvd->tc_xoffset-2;
			int u_idx = i/2 + dvd->tc_xoffset/2-1;
			int v_idx = i/2 + dvd->tc_xoffset/2-1;
			y_comp[y_idx] = 0x00;
			if (i%2==0)
			{
				u_comp[u_idx] = 0x80;
				v_comp[v_idx] = 0x80;
			}
		}
		y_comp += c->width;
		if (j%2 == 0)
		{
			u_comp += (c->width/2);
			v_comp += (c->width/2);
		}
	}
}
#endif

static int write_video_frame(internal_browse_encoder_t *dvd, const uint8_t *p_video, int32_t frame_num)
{
	AVFormatContext *oc = dvd->oc;
	AVStream *st = dvd->video_st;
    int out_size, ret;
    AVCodecContext *c;
    
    c = st->codec;
    
    fill_yuv_image(p_video, dvd->picture, c->width, c->height);

#if 0    
	if (frame_num > 0)
	{
		setup_tc_mask(dvd, frame_num);
		burn_mask_yuv420(dvd);
	}
#endif    
    
    /* encode the image */
    out_size = avcodec_encode_video(c, dvd->video_outbuf, dvd->video_outbuf_size, dvd->picture);
    
    /* if zero size, it means the image was buffered */
    if (out_size > 0) {
  		//static int g_frame_count = 0;
        AVPacket pkt;
        av_init_packet(&pkt);
            
        pkt.pts= av_rescale_q(c->coded_frame->pts, c->time_base, st->time_base);
        //pkt.pts = g_frame_count++;
        if(c->coded_frame->key_frame)
            pkt.flags |= PKT_FLAG_KEY;
        pkt.stream_index= st->index;
        pkt.data= dvd->video_outbuf;
        pkt.size= out_size;
        
        /* write the compressed frame in the media file */
	if (0)
		printf("pkt: pts=%20"PRId64" dts=%20"PRId64" sidx=%d fl=%d dur=%d pos=%"PRId64" size=%5d data[0..7]={%02x %02x %02x %02x %02x %02x %02x %02x}\n",
				pkt.pts,
				pkt.dts,
				pkt.stream_index,
				pkt.flags,
				pkt.duration,
				pkt.pos,
				pkt.size,
				pkt.data[0], pkt.data[1], pkt.data[2], pkt.data[3], pkt.data[4], pkt.data[5], pkt.data[6], pkt.data[7]
				);
//        ret = av_interleaved_write_frame(oc, &pkt);
        ret = av_write_frame(oc, &pkt);
    } else {
        ret = 0;
    }
    if (ret != 0) {
        fprintf(stderr, "Error while writing video frame\n");
        return -1;
    }
    dvd->frame_count++;
	return ret;
}

extern int browse_encoder_encode (browse_encoder_t *in_dvd, const uint8_t *p_video, const int16_t *p_audio, int32_t frame_number)
{
	internal_browse_encoder_t *dvd = (internal_browse_encoder_t *)in_dvd;
	if (!dvd)
		return -1;

	if (p_video && write_video_frame (dvd, p_video, frame_number) == -1)
			return -1;

	if (p_audio)
	{
        /*
        Audio comes in in video frames (1920 samples) but is encoded
        as MPEG frames (1152 samples) so we need to buffer.
        NB. audio_inbuf_offset is in terms of 16-bit samples, hence the
        rather confusing pointer arithmetic.
        */
		memcpy (dvd->audio_inbuf + dvd->audio_inbuf_offset, p_audio, 1920*2*2);
		dvd->audio_inbuf_offset += (1920*2);
		while (dvd->audio_inbuf_offset >= (MPA_FRAME_SIZE*4))
		{
			if (write_audio_frame (dvd, dvd->audio_inbuf) == -1)
				return -1;
			dvd->audio_inbuf_offset -= (MPA_FRAME_SIZE*2);
			memmove (dvd->audio_inbuf, dvd->audio_inbuf+(MPA_FRAME_SIZE*2), dvd->audio_inbuf_offset*2);
		}
	}
	return 0;
}

extern int browse_encoder_close (browse_encoder_t *in_dvd)
{
	internal_browse_encoder_t *dvd = (internal_browse_encoder_t *)in_dvd;
	if (!dvd)
		return -1;

	if (dvd->video_st)
	{
		close_video(dvd);
		dvd->video_st = NULL;
	}
	if (dvd->audio_st)
	{
		close_audio(dvd);
		dvd->audio_st = NULL;
	}
	/* write the trailer, if any */
    av_write_trailer(dvd->oc);
	if (!(dvd->oc->oformat->flags & AVFMT_NOFILE))
	{
        /* close the output file */
#if (LIBAVFORMAT_VERSION_INT >= ((52<<16)+(0<<8)+0))
        url_fclose(dvd->oc->pb);
#else
        url_fclose(&dvd->oc->pb);
#endif
    }
	cleanup (dvd);
	return 0;
}
