/*
 * $Id: dump_vc3.c,v 1.1 2010/06/02 10:52:38 philipn Exp $
 *
 * Dump SMPTE VC-3 (Avid DNxHD) bitstream
 *
 * Copyright (C) 2010  British Broadcasting Corporation.
 * All Rights Reserved.
 *
 * Author: Philip de Nier
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
 * 02110-1301, USA.
 */

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <errno.h>
#include <inttypes.h>
#include <assert.h>



#define CHECK(cmd) \
    if (!(cmd)) { \
        fprintf(stderr, "\nERROR: Parse failure at code line %d and before file pos %ld\n", __LINE__, ftell(data->in_file)); \
        return 0; \
    }

#define REPORT_INVALID_DATA(reason, offset) \
    fprintf(stderr, "\nERROR: %s\nInvalid data at code line %d and file pos %ld\n", reason, __LINE__, ftell(data->in_file) + offset);



typedef struct
{
    uint16_t codeword;
    unsigned int codeword_size;
} VLCTable;

static const VLCTable DC_VLC_TABLE_1235[] =
{{10, 4},{62, 6},{11, 4},{12, 4},{13, 4},{0, 3},{1, 3},{2, 3},{3, 3},{4, 3},{14, 4},{30, 5},{126, 7},{127, 7}};

static const VLCTable DC_VLC_TABLE_1237[] =
{{0, 3},{12, 4},{13, 4},{1, 3},{2, 3},{3, 3},{4, 3},{5, 3},{14, 4},{30, 5},{62, 6},{63, 6}};

static const VLCTable DC_VLC_TABLE_1238[] =
{{0, 3},{12, 4},{13, 4},{1, 3},{2, 3},{3, 3},{4, 3},{5, 3},{14, 4},{30, 5},{62, 6},{63, 6}};

static const VLCTable DC_VLC_TABLE_1250[] =
{{10, 4},{62, 6},{11, 4},{12, 4},{13, 4},{0, 3},{1, 3},{2, 3},{3, 3},{4, 3},{14, 4},{30, 5},{126, 7},{127, 7}};

static const VLCTable DC_VLC_TABLE_1251[] =
{{0, 3},{12, 4},{13, 4},{1, 3},{2, 3},{3, 3},{4, 3},{5, 3},{14, 4},{30, 5},{62, 6},{63, 6}};

static const VLCTable DC_VLC_TABLE_1252[] =
{{0, 3},{12, 4},{13, 4},{1, 3},{2, 3},{3, 3},{4, 3},{5, 3},{14, 4},{30, 5},{62, 6},{63, 6}};


static const VLCTable AC_VLC_TABLE_1235[] =
{{0, 2},{1, 2},{4, 3},{10, 4},{11, 4},{24, 5},{25, 5},{26, 5},{54, 6},{55, 6},{56, 6},{57, 6},{116, 7},{117, 7},{118, 7},{119, 7},{240, 8},{241, 8},{242, 8},{243, 8},{244, 8},{245, 8},{492, 9},{493, 9},{494, 9},{495, 9},{496, 9},{497, 9},{498, 9},{998, 10},{999, 10},{1000, 10},{1001, 10},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{1006, 10},{1007,10},{2016, 11},{2017, 11},{2018, 11},{2019, 11},{2020, 11},{2021, 11},{2022, 11},{2023, 11},{2024, 11},{2025, 11},{2026, 11},{4054, 12},{4055, 12},{4056, 12},{4057, 12},{4058, 12},{4059, 12},{4060, 12},{4061, 12},{4062, 12},{4063, 12},{4064, 12},{4065, 12},{4066, 12},{4067, 12},{4068, 12},{4069, 12},{8140, 13},{8141, 13},{8142, 13},{8143, 13},{8144, 13},{8145, 13},{8146, 13},{8147, 13},{8148, 13},{8149, 13},{8150, 13},{8151, 13},{8152, 13},{8153, 13},{8154, 13},{8155, 13},{8156, 13},{8157, 13},{16316, 14},{16317, 14},{16318, 14},{16319, 14},{16320, 14},{16321, 14},{16322, 14},{16323, 14},{16324, 14},{16325, 14},{16326, 14},{16327, 14},{16328, 14},{16329, 14},{16330, 14},{16331, 14},{16332, 14},{16333, 14},{16334, 14},{16335, 14},{16336, 14},{16337, 14},{32676, 15},{32677, 15},{32678, 15},{32679, 15},{32680, 15},{32681, 15},{32682, 15},{32683, 15},{32684, 15},{32685, 15},{32686, 15},{32687, 15},{32688, 15},{32689, 15},{32690, 15},{32691, 15},{32692, 15},{32693, 15},{32694, 15},{32695, 15},{32696, 15},{32697, 15},{32698, 15},{32699, 15},{32700, 15},{32701, 15},{32702, 15},{32703, 15},{32704, 15},{32705, 15},{32706, 15},{32707, 15},{32708, 15},{65418, 16},{65419, 16},{65420, 16},{65421, 16},{65422, 16},{65423, 16},{65424, 16},{65425, 16},{65426, 16},{65427, 16},{65428, 16},{65429, 16},{65430, 16},{65431, 16},{65432, 16},{65433, 16},{65434, 16},{65435, 16},{65436, 16},{65437, 16},{65438, 16},{65439, 16},{65440, 16},{65441, 16},{65442, 16},{65443, 16},{65444, 16},{65445, 16},{65446, 16},{65447, 16},{65448, 16},{65449, 16},{65450, 16},{65451, 16},{65452,16},{65453, 16},{65454, 16},{65455, 16},{65456, 16},{65457, 16},{65458, 16},{65459, 16},{65460, 16},{65461, 16},{65462, 16},{65463, 16},{65464, 16},{65465, 16},{65466, 16},{65467, 16},{65468, 16},{65469, 16},{65470, 16},{65471, 16},{65472, 16},{65473, 16},{65474, 16},{65475, 16},{65476, 16},{65477, 16},{65478, 16},{65479, 16},{65480, 16},{65481, 16},{65482, 16},{65483, 16},{65484, 16},{65485, 16},{65486, 16},{65487, 16},{65488, 16},{65489, 16},{65490, 16},{65491, 16},{65492, 16},{65493, 16},{65494, 16},{65495, 16},{65496, 16},{65497, 16},{65498, 16},{65499, 16},{65500, 16},{65501, 16},{65502, 16},{65503, 16},{65504, 16},{65505, 16},{65506, 16},{65507, 16},{65508, 16},{65509, 16},{65510, 16},{65511, 16},{65512, 16},{65513, 16},{65514, 16},{65515, 16},{65516, 16},{65517, 16},{65518, 16},{65519, 16},{65520, 16},{65521, 16},{65522, 16},{65523, 16},{65524, 16},{65525, 16},{65526, 16},{65527, 16},{65528, 16},{65529, 16},{65530, 16},{65531, 16},{65532, 16},{65533, 16},{65534, 16},{65535, 16}};

static const VLCTable AC_VLC_TABLE_1237[] =
{{0, 2},{1, 2},{4, 3},{5, 3},{12, 4},{26, 5},{27, 5},{56, 6},{57, 6},{58, 6},{59, 6},{120, 7},{121, 7},{244, 8},{245, 8},{246, 8},{247, 8},{248, 8},{498, 9},{499, 9},{500, 9},{501, 9},{502, 9},{1006, 10},{1007, 10},{1008, 10},{1009, 10},{1010, 10},{1011, 10},{2024, 11},{2025, 11},{2026, 11},{2027, 11},{2028, 11},{2029, 11},{2030, 11},{2031, 11},{4064, 12},{4065, 12},{4066, 12},{4067, 12},{4068, 12},{4069, 12},{4070, 12},{4071, 12},{4072, 12},{4073, 12},{8148, 13},{8149, 13},{8150, 13},{8151, 13},{8152, 13},{8153, 13},{8154, 13},{8155, 13},{8156, 13},{8157, 13},{8158, 13},{16318, 14},{16319, 14},{16320, 14},{16321, 14},{16322, 14},{16323, 14},{16324, 14},{16325, 14},{16326, 14},{16327, 14},{16328, 14},{16329, 14},{16330, 14},{16331, 14},{16332, 14},{16333, 14},{32668, 15},{32669, 15},{32670, 15},{32671, 15},{32672, 15},{32673, 15},{32674, 15},{32675, 15},{32676, 15},{32677, 15},{32678, 15},{32679, 15},{32680, 15},{32681, 15},{32682, 15},{32683, 15},{32684, 15},{65370, 16},{65371, 16},{65372, 16},{65373, 16},{65374, 16},{65375, 16},{65376, 16},{65377, 16},{65378, 16},{65379, 16},{65380, 16},{65381, 16},{65382, 16},{65383, 16},{65384, 16},{65385, 16},{65386, 16},{65387, 16},{65388, 16},{65389, 16},{65390, 16},{65391, 16},{65392, 16},{65393, 16},{65394, 16},{65395, 16},{65396, 16},{65397, 16},{65398, 16},{65399, 16},{65400, 16},{65401, 16},{65402, 16},{65403, 16},{65404, 16},{65405, 16},{65406, 16},{65407, 16},{65408, 16},{65409, 16},{65410, 16},{65411, 16},{65412, 16},{65413, 16},{65414, 16},{65415, 16},{65416, 16},{65417, 16},{65418, 16},{65419, 16},{65420, 16},{65421, 16},{65422, 16},{65423, 16},{65424, 16},{65425, 16},{65426, 16},{65427, 16},{65428, 16},{65429, 16},{65430, 16},{65431, 16},{65432, 16},{65433, 16},{65434, 16},{65435, 16},{65436, 16},{65437, 16},{65438, 16},{65439, 16},{65440, 16},{65441, 16},{65442, 16},{65443, 16},{65444, 16},{65445, 16},{65446, 16},{65447, 16},{65448, 16},{65449, 16},{65450, 16},{65451, 16},{65452, 16},{65453, 16},{65454, 16},{65455, 16},{65456, 16},{65457, 16},{65458, 16},{65459, 16},{65460, 16},{65461, 16},{65462, 16},{65463, 16},{65464, 16},{65465, 16},{65466, 16},{65467, 16},{65468, 16},{65469, 16},{65470, 16},{65471, 16},{65472, 16},{65473, 16},{65474, 16},{65475, 16},{65476, 16},{65477, 16},{65478, 16},{65479, 16},{65480, 16},{65481, 16},{65482, 16},{65483, 16},{65484, 16},{65485, 16},{65486, 16},{65487, 16},{65488, 16},{65489, 16},{65490, 16},{65491, 16},{65492, 16},{65493, 16},{65494, 16},{65495, 16},{65496, 16},{65497, 16},{65498, 16},{65499, 16},{65500, 16},{65501, 16},{65502, 16},{65503, 16},{65504, 16},{65505, 16},{65506, 16},{65507,16},{65508, 16},{65509, 16},{65510, 16},{65511, 16},{65512, 16},{65513, 16},{65514, 16},{65515, 16},{65516, 16},{65517, 16},{65518, 16},{65519, 16},{65520, 16},{65521, 16},{65522, 16},{65523, 16},{65524, 16},{65525, 16},{65526, 16},{65527, 16},{65528, 16},{65529, 16},{65530, 16},{65531, 16},{65532, 16},{65533, 16},{65534, 16},{65535, 16}};

static const VLCTable AC_VLC_TABLE_1238[] =
{{0, 2},{1, 2},{4, 3},{10, 4},{11, 4},{24, 5},{25, 5},{26, 5},{54, 6},{55, 6},{56, 6},{57, 6},{116, 7},{117, 7},{118, 7},{119, 7},{240, 8},{241, 8},{242, 8},{243, 8},{244, 8},{245, 8},{492, 9},{493, 9},{494, 9},{495, 9},{496, 9},{497, 9},{498, 9},{499, 9},{1000, 10},{1001, 10},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{1006, 10},{1007, 10},{1008,10},{2018, 11},{2019, 11},{2020, 11},{2021, 11},{2022, 11},{2023, 11},{2024, 11},{2025, 11},{2026, 11},{2027, 11},{4056, 12},{4057, 12},{4058, 12},{4059, 12},{4060, 12},{4061, 12},{4062, 12},{4063, 12},{4064, 12},{4065, 12},{4066, 12},{4067, 12},{4068, 12},{4069, 12},{8140, 13},{8141, 13},{8142, 13},{8143, 13},{8144, 13},{8145, 13},{8146, 13},{8147, 13},{8148, 13},{8149, 13},{8150, 13},{8151, 13},{8152, 13},{8153, 13},{8154, 13},{8155, 13},{8156, 13},{16314, 14},{16315, 14},{16316, 14},{16317, 14},{16318, 14},{16319, 14},{16320, 14},{16321, 14},{16322, 14},{16323, 14},{16324, 14},{16325, 14},{16326, 14},{16327, 14},{16328, 14},{16329, 14},{16330, 14},{16331, 14},{16332, 14},{16333, 14},{16334, 14},{16335, 14},{16336, 14},{16337, 14},{16338, 14},{32678, 15},{32679, 15},{32680, 15},{32681, 15},{32682, 15},{32683, 15},{32684, 15},{32685, 15},{32686, 15},{32687, 15},{32688, 15},{32689, 15},{32690, 15},{32691, 15},{32692, 15},{32693, 15},{32694, 15},{32695, 15},{32696, 15},{32697, 15},{32698, 15},{32699, 15},{32700, 15},{32701, 15},{32702, 15},{32703, 15},{32704, 15},{32705, 15},{65412, 16},{65413, 16},{65414, 16},{65415, 16},{65416, 16},{65417, 16},{65418, 16},{65419, 16},{65420, 16},{65421, 16},{65422, 16},{65423, 16},{65424, 16},{65425, 16},{65426, 16},{65427, 16},{65428, 16},{65429, 16},{65430, 16},{65431, 16},{65432, 16},{65433, 16},{65434, 16},{65435, 16},{65436, 16},{65437, 16},{65438, 16},{65439, 16},{65440, 16},{65441, 16},{65442, 16},{65443, 16},{65444, 16},{65445, 16},{65446, 16},{65447, 16},{65448, 16},{65449, 16},{65450, 16},{65451, 16},{65452, 16},{65453, 16},{65454, 16},{65455, 16},{65456, 16},{65457, 16},{65458, 16},{65459, 16},{65460, 16},{65461, 16},{65462, 16},{65463, 16},{65464, 16},{65465, 16},{65466, 16},{65467, 16},{65468, 16},{65469, 16},{65470, 16},{65471, 16},{65472, 16},{65473, 16},{65474, 16},{65475, 16},{65476, 16},{65477, 16},{65478, 16},{65479, 16},{65480, 16},{65481, 16},{65482, 16},{65483, 16},{65484, 16},{65485, 16},{65486, 16},{65487, 16},{65488, 16},{65489, 16},{65490, 16},{65491, 16},{65492, 16},{65493, 16},{65494, 16},{65495, 16},{65496, 16},{65497, 16},{65498, 16},{65499, 16},{65500, 16},{65501, 16},{65502, 16},{65503, 16},{65504, 16},{65505, 16},{65506, 16},{65507, 16},{65508, 16},{65509, 16},{65510,16},{65511, 16},{65512, 16},{65513, 16},{65514, 16},{65515, 16},{65516, 16},{65517, 16},{65518, 16},{65519, 16},{65520, 16},{65521, 16},{65522, 16},{65523, 16},{65524, 16},{65525, 16},{65526, 16},{65527, 16},{65528, 16},{65529, 16},{65530, 16},{65531, 16},{65532, 16},{65533, 16},{65534, 16},{65535, 16}};

static const VLCTable AC_VLC_TABLE_1250[] =
{{0, 2},{1, 2},{4, 3},{10, 4},{11, 4},{24, 5},{25, 5},{26, 5},{54, 6},{55, 6},{56, 6},{57, 6},{116, 7},{117, 7},{118, 7},{119, 7},{240, 8},{241, 8},{242, 8},{243, 8},{244, 8},{245, 8},{492, 9},{493, 9},{494, 9},{495, 9},{496, 9},{497, 9},{498, 9},{998, 10},{999, 10},{1000, 10},{1001, 10},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{1006, 10},{2014,11},{2015, 11},{2016, 11},{2017, 11},{2018, 11},{2019, 11},{2020, 11},{2021, 11},{2022, 11},{2023, 11},{2024, 11},{2025, 11},{4052, 12},{4053, 12},{4054, 12},{4055, 12},{4056, 12},{4057, 12},{4058, 12},{4059, 12},{4060, 12},{4061, 12},{4062, 12},{4063, 12},{4064, 12},{4065, 12},{4066, 12},{4067, 12},{8136, 13},{8137, 13},{8138, 13},{8139, 13},{8140, 13},{8141, 13},{8142, 13},{8143, 13},{8144, 13},{8145, 13},{8146, 13},{8147, 13},{8148, 13},{8149, 13},{8150, 13},{8151, 13},{8152, 13},{8153, 13},{8154, 13},{8155, 13},{8156, 13},{16314, 14},{16315, 14},{16316, 14},{16317, 14},{16318, 14},{16319, 14},{16320, 14},{16321, 14},{16322, 14},{16323, 14},{16324, 14},{16325, 14},{16326, 14},{16327, 14},{16328, 14},{16329, 14},{16330, 14},{16331, 14},{16332, 14},{16333, 14},{16334, 14},{16335, 14},{16336, 14},{16337, 14},{16338, 14},{32678, 15},{32679, 15},{32680, 15},{32681, 15},{32682, 15},{32683, 15},{32684, 15},{32685, 15},{32686, 15},{32687, 15},{32688, 15},{32689, 15},{32690, 15},{32691, 15},{32692, 15},{32693, 15},{32694, 15},{32695, 15},{32696, 15},{32697, 15},{32698, 15},{32699, 15},{32700, 15},{32701, 15},{32702, 15},{32703, 15},{32704, 15},{32705, 15},{32706, 15},{32707, 15},{32708, 15},{32709, 15},{32710, 15},{32711, 15},{32712, 15},{65426, 16},{65427, 16},{65428, 16},{65429, 16},{65430, 16},{65431, 16},{65432, 16},{65433, 16},{65434, 16},{65435, 16},{65436, 16},{65437, 16},{65438, 16},{65439, 16},{65440, 16},{65441, 16},{65442, 16},{65443, 16},{65444, 16},{65445, 16},{65446, 16},{65447, 16},{65448, 16},{65449, 16},{65450, 16},{65451, 16},{65452, 16},{65453, 16},{65454, 16},{65455, 16},{65456, 16},{65457, 16},{65458, 16},{65459, 16},{65460, 16},{65461, 16},{65462, 16},{65463, 16},{65464, 16},{65465, 16},{65466, 16},{65467, 16},{65468, 16},{65469, 16},{65470, 16},{65471, 16},{65472, 16},{65473, 16},{65474, 16},{65475, 16},{65476, 16},{65477, 16},{65478, 16},{65479, 16},{65480, 16},{65481, 16},{65482, 16},{65483, 16},{65484, 16},{65485, 16},{65486, 16},{65487, 16},{65488, 16},{65489, 16},{65490, 16},{65491, 16},{65492, 16},{65493, 16},{65494, 16},{65495, 16},{65496,16},{65497, 16},{65498, 16},{65499, 16},{65500, 16},{65501, 16},{65502, 16},{65503, 16},{65504, 16},{65505, 16},{65506, 16},{65507, 16},{65508, 16},{65509, 16},{65510, 16},{65511, 16},{65512, 16},{65513, 16},{65514, 16},{65515, 16},{65516, 16},{65517, 16},{65518, 16},{65519, 16},{65520, 16},{65521, 16},{65522, 16},{65523, 16},{65524, 16},{65525, 16},{65526, 16},{65527, 16},{65528, 16},{65529, 16},{65530, 16},{65531, 16},{65532, 16},{65533, 16},{65534, 16},{65535, 16}};

static const VLCTable AC_VLC_TABLE_1251[] =
{{0, 2},{1, 2},{4, 3},{10, 4},{11, 4},{24, 5},{25, 5},{26, 5},{54, 6},{55, 6},{56, 6},{57, 6},{116, 7},{117, 7},{118, 7},{119, 7},{240, 8},{241, 8},{242, 8},{243, 8},{244, 8},{245, 8},{492, 9},{493, 9},{494, 9},{495, 9},{496, 9},{497, 9},{996, 10},{997, 10},{998, 10},{999, 10},{1000, 10},{1001, 10},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{2012,11},{2013, 11},{2014, 11},{2015, 11},{2016, 11},{2017, 11},{2018, 11},{2019, 11},{2020, 11},{2021, 11},{2022, 11},{2023, 11},{2024, 11},{2025, 11},{4052, 12},{4053, 12},{4054, 12},{4055, 12},{4056, 12},{4057, 12},{4058, 12},{4059, 12},{4060, 12},{4061, 12},{4062, 12},{4063, 12},{4064, 12},{4065, 12},{4066, 12},{8134, 13},{8135, 13},{8136, 13},{8137, 13},{8138, 13},{8139, 13},{8140, 13},{8141, 13},{8142, 13},{8143, 13},{8144, 13},{8145, 13},{8146, 13},{8147, 13},{8148, 13},{8149, 13},{8150, 13},{8151, 13},{8152, 13},{8153, 13},{8154, 13},{8155, 13},{8156, 13},{16314, 14},{16315, 14},{16316, 14},{16317, 14},{16318, 14},{16319, 14},{16320, 14},{16321, 14},{16322, 14},{16323, 14},{16324, 14},{16325, 14},{16326, 14},{16327, 14},{16328, 14},{16329, 14},{16330, 14},{16331, 14},{16332, 14},{16333, 14},{16334, 14},{16335, 14},{16336, 14},{16337, 14},{16338, 14},{16339, 14},{32680, 15},{32681, 15},{32682, 15},{32683, 15},{32684, 15},{32685, 15},{32686, 15},{32687, 15},{32688, 15},{32689, 15},{32690, 15},{32691, 15},{32692, 15},{32693, 15},{32694, 15},{32695, 15},{32696, 15},{32697, 15},{32698, 15},{32699, 15},{32700, 15},{32701, 15},{32702, 15},{32703, 15},{32704, 15},{32705, 15},{32706, 15},{32707, 15},{32708, 15},{32709, 15},{32710, 15},{32711, 15},{32712, 15},{32713, 15},{32714, 15},{65430, 16},{65431, 16},{65432, 16},{65433, 16},{65434, 16},{65435, 16},{65436, 16},{65437, 16},{65438, 16},{65439, 16},{65440, 16},{65441, 16},{65442, 16},{65443, 16},{65444, 16},{65445, 16},{65446, 16},{65447, 16},{65448, 16},{65449, 16},{65450, 16},{65451, 16},{65452, 16},{65453, 16},{65454, 16},{65455, 16},{65456, 16},{65457, 16},{65458, 16},{65459, 16},{65460, 16},{65461, 16},{65462, 16},{65463, 16},{65464, 16},{65465, 16},{65466, 16},{65467, 16},{65468, 16},{65469, 16},{65470, 16},{65471, 16},{65472, 16},{65473, 16},{65474, 16},{65475, 16},{65476, 16},{65477, 16},{65478, 16},{65479, 16},{65480, 16},{65481, 16},{65482, 16},{65483, 16},{65484, 16},{65485, 16},{65486, 16},{65487, 16},{65488, 16},{65489, 16},{65490, 16},{65491, 16},{65492, 16},{65493, 16},{65494, 16},{65495, 16},{65496, 16},{65497, 16},{65498, 16},{65499, 16},{65500, 16},{65501, 16},{65502, 16},{65503, 16},{65504, 16},{65505, 16},{65506, 16},{65507, 16},{65508, 16},{65509, 16},{65510, 16},{65511, 16},{65512, 16},{65513, 16},{65514, 16},{65515, 16},{65516, 16},{65517, 16},{65518, 16},{65519, 16},{65520, 16},{65521, 16},{65522, 16},{65523, 16},{65524, 16},{65525, 16},{65526, 16},{65527, 16},{65528, 16},{65529, 16},{65530, 16},{65531, 16},{65532, 16},{65533, 16},{65534, 16},{65535, 16}};

static const VLCTable AC_VLC_TABLE_1252[] =
{{0, 2},{1, 2},{4, 3},{10, 4},{11, 4},{12, 4},{26, 5},{27, 5},{56, 6},{57, 6},{58, 6},{118, 7},{119, 7},{120, 7},{242, 8},{243, 8},{244, 8},{245, 8},{246, 8},{247, 8},{496, 9},{497, 9},{498, 9},{499, 9},{500, 9},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{1006, 10},{1007, 10},{1008, 10},{1009, 10},{2020, 11},{2021, 11},{2022, 11},{2023, 11},{2024,11},{2025, 11},{2026, 11},{2027, 11},{2028, 11},{2029, 11},{4060, 12},{4061, 12},{4062, 12},{4063, 12},{4064, 12},{4065, 12},{4066, 12},{4067, 12},{4068, 12},{4069, 12},{4070, 12},{4071, 12},{8144, 13},{8145, 13},{8146, 13},{8147, 13},{8148, 13},{8149, 13},{8150, 13},{8151, 13},{8152, 13},{8153, 13},{8154, 13},{8155, 13},{8156, 13},{8157, 13},{8158, 13},{16318, 14},{16319, 14},{16320, 14},{16321, 14},{16322, 14},{16323, 14},{16324, 14},{16325, 14},{16326, 14},{16327, 14},{16328, 14},{16329, 14},{16330, 14},{16331, 14},{16332, 14},{16333, 14},{16334, 14},{16335, 14},{32672, 15},{32673, 15},{32674, 15},{32675, 15},{32676, 15},{32677, 15},{32678, 15},{32679, 15},{32680, 15},{32681, 15},{32682,15},{32683, 15},{32684, 15},{32685, 15},{32686, 15},{32687, 15},{32688, 15},{32689, 15},{32690, 15},{32691, 15},{32692, 15},{32693, 15},{32694, 15},{65390, 16},{65391, 16},{65392, 16},{65393, 16},{65394, 16},{65395, 16},{65396, 16},{65397, 16},{65398, 16},{65399, 16},{65400, 16},{65401, 16},{65402, 16},{65403, 16},{65404, 16},{65405, 16},{65406, 16},{65407, 16},{65408, 16},{65409, 16},{65410, 16},{65411, 16},{65412, 16},{65413, 16},{65414, 16},{65415, 16},{65416, 16},{65417, 16},{65418, 16},{65419, 16},{65420, 16},{65421, 16},{65422, 16},{65423, 16},{65424, 16},{65425, 16},{65426, 16},{65427, 16},{65428, 16},{65429, 16},{65430, 16},{65431, 16},{65432, 16},{65433, 16},{65434, 16},{65435, 16},{65436, 16},{65437, 16},{65438, 16},{65439, 16},{65440, 16},{65441, 16},{65442, 16},{65443, 16},{65444, 16},{65445, 16},{65446, 16},{65447, 16},{65448, 16},{65449, 16},{65450, 16},{65451, 16},{65452, 16},{65453, 16},{65454, 16},{65455, 16},{65456, 16},{65457, 16},{65458, 16},{65459, 16},{65460, 16},{65461, 16},{65462, 16},{65463, 16},{65464, 16},{65465, 16},{65466, 16},{65467, 16},{65468, 16},{65469, 16},{65470, 16},{65471, 16},{65472, 16},{65473, 16},{65474, 16},{65475, 16},{65476, 16},{65477, 16},{65478, 16},{65479, 16},{65480, 16},{65481, 16},{65482, 16},{65483, 16},{65484, 16},{65485, 16},{65486, 16},{65487, 16},{65488, 16},{65489, 16},{65490, 16},{65491, 16},{65492, 16},{65493, 16},{65494, 16},{65495, 16},{65496, 16},{65497, 16},{65498, 16},{65499, 16},{65500, 16},{65501, 16},{65502, 16},{65503, 16},{65504, 16},{65505, 16},{65506, 16},{65507, 16},{65508, 16},{65509, 16},{65510, 16},{65511, 16},{65512, 16},{65513, 16},{65514, 16},{65515, 16},{65516, 16},{65517, 16},{65518, 16},{65519, 16},{65520, 16},{65521, 16},{65522, 16},{65523, 16},{65524, 16},{65525, 16},{65526, 16},{65527, 16},{65528, 16},{65529, 16},{65530, 16},{65531, 16},{65532, 16},{65533, 16},{65534, 16},{65535, 16}};



static const VLCTable AC_RUN_VLC_TABLE_1235[] =
{{0, 1},{4, 3},{10, 4},{11, 4},{24, 5},{25, 5},{26, 5},{27, 5},{56, 6},{57, 6},{58, 6},{59, 6},{120, 7},{242, 8},{486, 9},{487, 9},{488, 9},{489, 9},{980, 10},{981, 10},{982, 10},{983, 10},{984, 10},{985, 10},{986, 10},{987, 10},{988, 10},{989, 10},{990, 10},{991, 10},{992, 10},{993, 10},{994, 10},{995, 10},{996, 10},{997, 10},{998, 10},{999, 10},{1000, 10},{1001, 10},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{1006, 10},{1007, 10},{1008, 10},{1009, 10},{1010, 10},{1011, 10},{1012, 10},{1013, 10},{1014, 10},{1015, 10},{1016, 10},{1017, 10},{1018, 10},{1019, 10},{1020, 10},{1021, 10},{1022, 10},{1023, 10}};

static uint8_t AC_RUN_TABLE_1235[] =
{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,20,17,19,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62};


static const VLCTable AC_RUN_VLC_TABLE_1237[] =
{{0, 1},{4, 3},{10, 4},{11, 4},{24, 5},{25, 5},{26, 5},{54, 6},{55, 6},{56, 6},{57, 6},{58, 6},{118, 7},{119, 7},{240, 8},{482, 9},{483, 9},{484, 9},{485, 9},{486, 9},{487, 9},{488, 9},{489, 9},{490, 9},{491, 9},{492, 9},{493, 9},{494, 9},{990, 10},{991, 10},{992, 10},{993, 10},{994, 10},{995, 10},{996, 10},{997, 10},{998, 10},{999, 10},{1000, 10},{1001, 10},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{1006, 10},{1007, 10},{1008, 10},{1009, 10},{1010, 10},{1011, 10},{1012, 10},{1013, 10},{1014, 10},{1015, 10},{1016, 10},{1017, 10},{1018, 10},{1019, 10},{1020, 10},{1021, 10},{1022, 10},{1023, 10}};

static uint8_t AC_RUN_TABLE_1237[] =
{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,53,57,58,59,60,61,62,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,54,55,56};


static const VLCTable AC_RUN_VLC_TABLE_1238[] =
{{0, 1},{4, 3},{10, 4},{11, 4},{24, 5},{25, 5},{26, 5},{27, 5},{56, 6},{57, 6},{58, 6},{59, 6},{120, 7},{242, 8},{486, 9},{487, 9},{488, 9},{489, 9},{980, 10},{981, 10},{982, 10},{983, 10},{984, 10},{985, 10},{986, 10},{987, 10},{988, 10},{989, 10},{990, 10},{991, 10},{992, 10},{993, 10},{994, 10},{995, 10},{996, 10},{997, 10},{998, 10},{999, 10},{1000, 10},{1001, 10},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{1006, 10},{1007, 10},{1008, 10},{1009, 10},{1010, 10},{1011, 10},{1012, 10},{1013, 10},{1014, 10},{1015, 10},{1016, 10},{1017, 10},{1018, 10},{1019, 10},{1020, 10},{1021, 10},{1022, 10},{1023, 10}};

static uint8_t AC_RUN_TABLE_1238[] =
{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,20,21,17,18,19,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62};


static const VLCTable AC_RUN_VLC_TABLE_1250[] =
{{0, 1},{4, 3},{5, 3},{12, 4},{26, 5},{27, 5},{28, 5},{58, 6},{118, 7},{119, 7},{120, 7},{242, 8},{486, 9},{487, 9},{976, 10},{977, 10},{978, 10},{979, 10},{980, 10},{981, 10},{982, 10},{983, 10},{984, 10},{985, 10},{986, 10},{987, 10},{988, 10},{989, 10},{990, 10},{991, 10},{992, 10},{993, 10},{994, 10},{995, 10},{996, 10},{997, 10},{998, 10},{999, 10},{1000, 10},{1001, 10},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{1006, 10},{1007, 10},{1008, 10},{1009, 10},{1010, 10},{1011, 10},{1012, 10},{1013, 10},{1014, 10},{1015, 10},{1016, 10},{1017, 10},{1018, 10},{1019, 10},{1020, 10},{1021, 10},{1022, 10},{1023, 10}};

static uint8_t AC_RUN_TABLE_1250[] =
{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62};


static const VLCTable AC_RUN_VLC_TABLE_1251[] =
{{0, 1},{4, 3},{5, 3},{12, 4},{26, 5},{27, 5},{28, 5},{58, 6},{118, 7},{119, 7},{120, 7},{242, 8},{486, 9},{487, 9},{976, 10},{977, 10},{978, 10},{979, 10},{980, 10},{981, 10},{982, 10},{983, 10},{984, 10},{985, 10},{986, 10},{987, 10},{988, 10},{989, 10},{990, 10},{991, 10},{992, 10},{993, 10},{994, 10},{995, 10},{996, 10},{997, 10},{998, 10},{999, 10},{1000, 10},{1001, 10},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{1006, 10},{1007, 10},{1008, 10},{1009, 10},{1010, 10},{1011, 10},{1012, 10},{1013, 10},{1014, 10},{1015, 10},{1016, 10},{1017, 10},{1018, 10},{1019, 10},{1020, 10},{1021, 10},{1022, 10},{1023, 10}};

static uint8_t AC_RUN_TABLE_1251[] =
{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62};


static const VLCTable AC_RUN_VLC_TABLE_1252[] =
{{0, 1},{4, 3},{5, 3},{12, 4},{26, 5},{27, 5},{28, 5},{58, 6},{118, 7},{119, 7},{120, 7},{242, 8},{486, 9},{487, 9},{976, 10},{977, 10},{978, 10},{979, 10},{980, 10},{981, 10},{982, 10},{983, 10},{984, 10},{985, 10},{986, 10},{987, 10},{988, 10},{989, 10},{990, 10},{991, 10},{992, 10},{993, 10},{994, 10},{995, 10},{996, 10},{997, 10},{998, 10},{999, 10},{1000, 10},{1001, 10},{1002, 10},{1003, 10},{1004, 10},{1005, 10},{1006, 10},{1007, 10},{1008, 10},{1009, 10},{1010, 10},{1011, 10},{1012, 10},{1013, 10},{1014, 10},{1015, 10},{1016, 10},{1017, 10},{1018, 10},{1019, 10},{1020, 10},{1021, 10},{1022, 10},{1023, 10}};

static uint8_t AC_RUN_TABLE_1252[] =
{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62};



typedef struct
{
    uint8_t amplitude;
    int run_flag;
    int index_flag;
} AmplitudeTable;


static const AmplitudeTable AC_AMPLITUDE_TABLE_1235[] =
{{1,0,0},{1,1,0},{2,0,0},{3,0,0},{0,0,0},{4,0,0},{5,0,0},{2,1,0},{6,0,0},{7,0,0},{8,0,0},{3,1,0},{9,0,0},{10,0,0},{11,0,0},{4,1,0},{12,0,0},{13,0,0},{14,0,0},{15,0,0},{16,0,0},{5,1,0},{17,0,0},{18,0,0},{19,0,0},{20,0,0},{21,0,0},{6,1,0},{7,1,0},{22,0,0},{23,0,0},{24,0,0},{25,0,0},{26,0,0},{27,0,0},{28,0,0},{29,0,0},{8,1,0},{9,1,0},{30,0,0},{31,0,0},{32,0,0},{33,0,0},{34,0,0},{35,0,0},{36,0,0},{37,0,0},{38,0,0},{10,10,0},{11,11,0},{39,0,0},{40,0,0},{41,0,0},{42,0,0},{43,0,0},{44,0,0},{45,0,0},{46,0,0},{47,0,0},{48,0,0},{49,0,0},{50,0,0},{12,12,0},{13,13,0},{14,14,0},{15,15,0},{51,0,0},{52,0,0},{53,0,0},{54,0,0},{55,0,0},{56,0,0},{57,0,0},{58,0,0},{59,0,0},{60,0,0},{61,0,0},{62,0,0},{63,0,0},{1,0,1},{16,16,0},{17,17,0},{18,18,0},{19,19,0},{64,0,0},{2,0,1},{3,0,1},{4,0,1},{5,0,1},{6,0,1},{7,0,1},{8,0,1},{9,0,1},{10,0,10},{11,0,11},{12,0,12},{13,0,13},{14,0,14},{15,0,15},{16,0,16},{17,0,17},{20,10,0},{21,11,0},{22,12,0},{23,13,0},{24,14,0},{18,0,18},{19,0,19},{20,0,10},{21,0,11},{22,0,12},{23,0,13},{24,0,14},{25,0,15},{26,0,16},{27,0,17},{28,0,18},{29,0,19},{30,0,10},{31,0,11},{32,0,12},{33,0,13},{34,0,14},{35,0,15},{36,0,16},{37,0,17},{38,0,18},{39,0,19},{40,0,10},{41,0,11},{42,0,12},{25,15,0},{26,16,0},{27,17,0},{28,18,0},{29,19,0},{30,10,0},{31,11,0},{32,12,0},{43,0,13},{44,0,14},{45,0,15},{46,0,16},{47,0,17},{48,0,18},{49,0,19},{50,0,10},{51,0,11},{52,0,12},{53,0,13},{54,0,14},{55,0,15},{56,0,16},{57,0,17},{58,0,18},{59,0,19},{60,0,10},{61,0,11},{62,0,12},{63,0,13},{64,0,14},{33,13,0},{34,14,0},{35,15,0},{36,16,0},{37,17,0},{38,18,0},{39,19,0},{40,10,0},{41,11,0},{42,12,0},{43,13,0},{44,14,0},{45,15,0},{46,16,0},{47,17,0},{48,18,0},{49,19,0},{50,10,0},{51,11,0},{52,12,0},{53,13,0},{54,14,0},{55,15,0},{56,16,0},{57,17,0},{58,18,0},{59,19,0},{60,10,0},{61,11,0},{62,12,0},{63,13,0},{64,14,0},{1,1,1},{2,1,1},{3,1,1},{4,1,1},{5,1,1},{6,1,1},{7,1,1},{8,1,1},{9,1,1},{10,10,10},{11,11,11},{12,12,12},{13,13,13},{14,14,14},{15,15,15},{16,16,16},{17,17,17},{18,18,18},{19,19,19},{20,10,10},{21,11,11},{22,12,12},{23,13,13},{24,14,14},{25,15,15},{26,16,16},{27,17,17},{28,18,18},{29,19,19},{30,10,10},{31,11,11},{32,12,12},{33,13,13},{34,14,14},{35,15,15},{36,16,16},{37,17,17},{38,18,18},{39,19,19},{40,10,10},{41,11,11},{42,12,12},{43,13,13},{44,14,14},{45,15,15},{46,16,16},{47,17,17},{48,18,18},{49,19,19},{50,10,10},{51,11,11},{52,12,12},{53,13,13},{54,14,14},{55,15,15},{56,16,16},{57,17,17},{58,18,18},{59,19,19},{60,10,10},{61,11,11},{62,12,12},{63,13,13},{64,14,14}};

static const AmplitudeTable AC_AMPLITUDE_TABLE_1237[] =
{{1,0,0},{1,1,0},{2,0,0},{0,0,0},{3,0,0},{4,0,0},{2,1,0},{5,0,0},{6,0,0},{7,0,0},{3,1,0},{8,0,0},{9,0,0},{10,0,0},{11,0,0},{12,0,0},{4,1,0},{5,1,0},{13,0,0},{14,0,0},{15,0,0},{16,0,0},{6,1,0},{17,0,0},{18,0,0},{19,0,0},{20,0,0},{21,0,0},{7,1,0},{22,0,0},{23,0,0},{24,0,0},{25,0,0},{26,0,0},{27,0,0},{8,1,0},{9,1,0},{28,0,0},{29,0,0},{30,0,0},{31,0,0},{32,0,0},{33,0,0},{34,0,0},{10,10,0},{11,11,0},{12,12,0},{35,0,0},{36,0,0},{37,0,0},{38,0,0},{39,0,0},{40,0,0},{41,0,0},{13,13,0},{14,14,0},{15,15,0},{16,16,0},{42,0,0},{43,0,0},{44,0,0},{45,0,0},{46,0,0},{47,0,0},{48,0,0},{49,0,0},{50,0,0},{51,0,0},{52,0,0},{17,17,0},{18,18,0},{19,19,0},{20,10,0},{21,11,0},{53,0,0},{54,0,0},{55,0,0},{56,0,0},{57,0,0},{58,0,0},{59,0,0},{60,0,0},{61,0,0},{64,0,0},{1,0,1},{22,12,0},{23,13,0},{24,14,0},{25,15,0},{26,16,0},{27,17,0},{62,0,0},{63,0,0},{2,0,1},{3,0,1},{4,0,1},{5,0,1},{6,0,1},{7,0,1},{8,0,1},{9,0,1},{10,0,10},{11,0,11},{12,0,12},{13,0,13},{14,0,14},{15,0,15},{16,0,16},{17,0,17},{18,0,18},{19,0,19},{20,0,10},{21,0,11},{22,0,12},{23,0,13},{24,0,14},{25,0,15},{26,0,16},{27,0,17},{28,0,18},{29,0,19},{30,0,10},{31,0,11},{32,0,12},{33,0,13},{34,0,14},{35,0,15},{36,0,16},{37,0,17},{38,0,18},{39,0,19},{40,0,10},{41,0,11},{42,0,12},{43,0,13},{44,0,14},{45,0,15},{46,0,16},{47,0,17},{48,0,18},{49,0,19},{50,0,10},{51,0,11},{52,0,12},{53,0,13},{54,0,14},{55,0,15},{56,0,16},{57,0,17},{58,0,18},{59,0,19},{60,0,10},{61,0,11},{62,0,12},{63,0,13},{64,0,14},{28,18,0},{29,19,0},{30,10,0},{31,11,0},{32,12,0},{33,13,0},{34,14,0},{35,15,0},{36,16,0},{37,17,0},{38,18,0},{39,19,0},{40,10,0},{41,11,0},{42,12,0},{43,13,0},{44,14,0},{45,15,0},{46,16,0},{47,17,0},{48,18,0},{49,19,0},{50,10,0},{51,11,0},{52,12,0},{53,13,0},{54,14,0},{55,15,0},{56,16,0},{57,17,0},{58,18,0},{59,19,0},{60,10,0},{61,11,0},{62,12,0},{63,13,0},{64,14,0},{1,1,1},{2,1,1},{3,1,1},{4,1,1},{5,1,1},{6,1,1},{7,1,1},{8,1,1},{9,1,1},{10,10,10},{11,11,11},{12,12,12},{13,13,13},{14,14,14},{15,15,15},{16,16,16},{17,17,17},{18,18,18},{19,19,19},{20,10,10},{21,11,11},{22,12,12},{23,13,13},{24,14,14},{25,15,15},{26,16,16},{27,17,17},{28,18,18},{29,19,19},{30,10,10},{31,11,11},{32,12,12},{33,13,13},{34,14,14},{35,15,15},{36,16,16},{37,17,17},{38,18,18},{39,19,19},{40,10,10},{41,11,11},{42,12,12},{43,13,13},{44,14,14},{45,15,15},{46,16,16},{47,17,17},{48,18,18},{49,19,19},{50,10,10},{51,11,11},{52,12,12},{53,13,13},{54,14,14},{55,15,15},{56,16,16},{57,17,17},{58,18,18},{59,19,19},{60,10,10},{61,11,11},{62,12,12},{63,13,13},{64,14,14}};

static const AmplitudeTable AC_AMPLITUDE_TABLE_1238[] =
{{1,0,0},{1,1,0},{2,0,0},{3,0,0},{0,0,0},{4,0,0},{5,0,0},{2,1,0},{6,0,0},{7,0,0},{8,0,0},{3,1,0},{9,0,0},{10,0,0},{11,0,0},{4,1,0},{12,0,0},{13,0,0},{14,0,0},{15,0,0},{16,0,0},{5,1,0},{17,0,0},{18,0,0},{19,0,0},{20,0,0},{21,0,0},{22,0,0},{6,1,0},{7,1,0},{23,0,0},{24,0,0},{25,0,0},{26,0,0},{27,0,0},{28,0,0},{29,0,0},{8,1,0},{9,1,0},{30,0,0},{31,0,0},{32,0,0},{33,0,0},{34,0,0},{35,0,0},{36,0,0},{37,0,0},{10,10,0},{11,11,0},{38,0,0},{39,0,0},{40,0,0},{41,0,0},{42,0,0},{43,0,0},{44,0,0},{45,0,0},{46,0,0},{47,0,0},{48,0,0},{12,12,0},{13,13,0},{14,14,0},{49,0,0},{50,0,0},{51,0,0},{52,0,0},{53,0,0},{54,0,0},{55,0,0},{56,0,0},{57,0,0},{58,0,0},{59,0,0},{60,0,0},{61,0,0},{15,15,0},{16,16,0},{17,17,0},{18,18,0},{62,0,0},{63,0,0},{64,0,0},{1,0,1},{2,0,1},{3,0,1},{4,0,1},{5,0,1},{6,0,1},{7,0,1},{8,0,1},{9,0,1},{10,0,10},{11,0,11},{12,0,12},{13,0,13},{14,0,14},{15,0,15},{16,0,16},{19,19,0},{20,10,0},{21,11,0},{22,12,0},{23,13,0},{24,14,0},{17,0,17},{18,0,18},{19,0,19},{20,0,10},{21,0,11},{22,0,12},{23,0,13},{24,0,14},{25,0,15},{26,0,16},{27,0,17},{28,0,18},{29,0,19},{30,0,10},{31,0,11},{32,0,12},{33,0,13},{34,0,14},{35,0,15},{36,0,16},{37,0,17},{40,0,10},{25,15,0},{26,16,0},{27,17,0},{28,18,0},{29,19,0},{30,10,0},{38,0,18},{39,0,19},{41,0,11},{42,0,12},{43,0,13},{44,0,14},{45,0,15},{46,0,16},{47,0,17},{48,0,18},{49,0,19},{50,0,10},{51,0,11},{52,0,12},{53,0,13},{54,0,14},{55,0,15},{56,0,16},{57,0,17},{58,0,18},{59,0,19},{60,0,10},{61,0,11},{62,0,12},{63,0,13},{64,0,14},{31,11,0},{32,12,0},{33,13,0},{34,14,0},{35,15,0},{36,16,0},{37,17,0},{38,18,0},{39,19,0},{40,10,0},{41,11,0},{42,12,0},{43,13,0},{44,14,0},{45,15,0},{46,16,0},{47,17,0},{48,18,0},{49,19,0},{50,10,0},{51,11,0},{52,12,0},{53,13,0},{54,14,0},{55,15,0},{56,16,0},{57,17,0},{58,18,0},{59,19,0},{60,10,0},{61,11,0},{62,12,0},{63,13,0},{64,14,0},{1,1,1},{2,1,1},{3,1,1},{4,1,1},{5,1,1},{6,1,1},{7,1,1},{8,1,1},{9,1,1},{10,10,10},{11,11,11},{12,12,12},{13,13,13},{14,14,14},{15,15,15},{16,16,16},{17,17,17},{18,18,18},{19,19,19},{20,10,10},{21,11,11},{22,12,12},{23,13,13},{24,14,14},{25,15,15},{26,16,16},{27,17,17},{28,18,18},{29,19,19},{30,10,10},{31,11,11},{32,12,12},{33,13,13},{34,14,14},{35,15,15},{36,16,16},{37,17,17},{38,18,18},{39,19,19},{40,10,10},{41,11,11},{42,12,12},{43,13,13},{44,14,14},{45,15,15},{46,16,16},{47,17,17},{48,18,18},{49,19,19},{50,10,10},{51,11,11},{52,12,12},{53,13,13},{54,14,14},{55,15,15},{56,16,16},{57,17,17},{58,18,18},{59,19,19},{60,10,10},{61,11,11},{62,12,12},{63,13,13},{64,14,14}};

static const AmplitudeTable AC_AMPLITUDE_TABLE_1250[] =
{{1,0,0},{1,1,0},{2,0,0},{3,0,0},{0,0,0},{4,0,0},{5,0,0},{2,1,0},{6,0,0},{7,0,0},{8,0,0},{3,1,0},{9,0,0},{10,0,0},{11,0,0},{4,1,0},{12,0,0},{13,0,0},{14,0,0},{15,0,0},{16,0,0},{5,1,0},{17,0,0},{18,0,0},{19,0,0},{20,0,0},{21,0,0},{22,0,0},{6,1,0},{23,0,0},{24,0,0},{25,0,0},{26,0,0},{27,0,0},{28,0,0},{29,0,0},{7,1,0},{8,1,0},{30,0,0},{31,0,0},{32,0,0},{33,0,0},{34,0,0},{35,0,0},{36,0,0},{37,0,0},{38,0,0},{39,0,0},{9,1,0},{10,10,0},{40,0,0},{41,0,0},{42,0,0},{43,0,0},{44,0,0},{45,0,0},{46,0,0},{47,0,0},{48,0,0},{49,0,0},{50,0,0},{51,0,0},{52,0,0},{11,11,0},{12,12,0},{13,13,0},{53,0,0},{54,0,0},{55,0,0},{56,0,0},{57,0,0},{58,0,0},{59,0,0},{60,0,0},{61,0,0},{62,0,0},{63,0,0},{64,0,0},{1,0,1},{2,0,1},{3,0,1},{4,0,1},{5,0,1},{14,14,0},{15,15,0},{16,16,0},{17,17,0},{6,0,1},{7,0,1},{8,0,1},{9,0,1},{10,0,10},{11,0,11},{12,0,12},{13,0,13},{14,0,14},{15,0,15},{16,0,16},{17,0,17},{18,0,18},{19,0,19},{20,0,10},{21,0,11},{22,0,12},{23,0,13},{24,0,14},{25,0,15},{26,0,16},{18,18,0},{19,19,0},{20,10,0},{21,11,0},{27,0,17},{28,0,18},{29,0,19},{30,0,10},{31,0,11},{32,0,12},{33,0,13},{34,0,14},{35,0,15},{36,0,16},{37,0,17},{38,0,18},{39,0,19},{40,0,10},{41,0,11},{42,0,12},{43,0,13},{44,0,14},{45,0,15},{46,0,16},{47,0,17},{48,0,18},{49,0,19},{50,0,10},{51,0,11},{52,0,12},{53,0,13},{55,0,15},{56,0,16},{22,12,0},{23,13,0},{24,14,0},{25,15,0},{26,16,0},{27,17,0},{54,0,14},{57,0,17},{58,0,18},{59,0,19},{60,0,10},{61,0,11},{62,0,12},{63,0,13},{64,0,14},{28,18,0},{29,19,0},{30,10,0},{31,11,0},{32,12,0},{33,13,0},{34,14,0},{35,15,0},{36,16,0},{37,17,0},{38,18,0},{39,19,0},{40,10,0},{41,11,0},{42,12,0},{43,13,0},{44,14,0},{45,15,0},{46,16,0},{47,17,0},{48,18,0},{49,19,0},{50,10,0},{51,11,0},{52,12,0},{53,13,0},{54,14,0},{55,15,0},{56,16,0},{57,17,0},{58,18,0},{59,19,0},{60,10,0},{61,11,0},{62,12,0},{63,13,0},{64,14,0},{1,1,1},{2,1,1},{3,1,1},{4,1,1},{5,1,1},{6,1,1},{7,1,1},{8,1,1},{9,1,1},{10,10,10},{11,11,11},{12,12,12},{13,13,13},{14,14,14},{15,15,15},{16,16,16},{17,17,17},{18,18,18},{19,19,19},{20,10,10},{21,11,11},{22,12,12},{23,13,13},{24,14,14},{25,15,15},{26,16,16},{27,17,17},{28,18,18},{29,19,19},{30,10,10},{31,11,11},{32,12,12},{33,13,13},{34,14,14},{35,15,15},{36,16,16},{37,17,17},{38,18,18},{39,19,19},{40,10,10},{41,11,11},{42,12,12},{43,13,13},{44,14,14},{45,15,15},{46,16,16},{47,17,17},{48,18,18},{49,19,19},{50,10,10},{51,11,11},{52,12,12},{53,13,13},{54,14,14},{55,15,15},{56,16,16},{57,17,17},{58,18,18},{59,19,19},{60,10,10},{61,11,11},{62,12,12},{63,13,13},{64,14,14}};

static const AmplitudeTable AC_AMPLITUDE_TABLE_1251[] =
{{1,0,0},{1,1,0},{2,0,0},{3,0,0},{0,0,0},{4,0,0},{5,0,0},{2,1,0},{6,0,0},{7,0,0},{8,0,0},{3,1,0},{9,0,0},{10,0,0},{11,0,0},{4,1,0},{12,0,0},{13,0,0},{14,0,0},{15,0,0},{16,0,0},{5,1,0},{17,0,0},{18,0,0},{19,0,0},{20,0,0},{21,0,0},{6,1,0},{22,0,0},{23,0,0},{24,0,0},{25,0,0},{26,0,0},{27,0,0},{28,0,0},{29,0,0},{7,1,0},{8,1,0},{30,0,0},{31,0,0},{32,0,0},{33,0,0},{34,0,0},{35,0,0},{36,0,0},{37,0,0},{38,0,0},{39,0,0},{40,0,0},{9,1,0},{10,10,0},{11,11,0},{41,0,0},{42,0,0},{43,0,0},{44,0,0},{45,0,0},{46,0,0},{47,0,0},{48,0,0},{49,0,0},{50,0,0},{51,0,0},{52,0,0},{12,12,0},{13,13,0},{14,14,0},{53,0,0},{54,0,0},{55,0,0},{56,0,0},{57,0,0},{58,0,0},{59,0,0},{60,0,0},{61,0,0},{62,0,0},{63,0,0},{64,0,0},{1,0,1},{2,0,1},{3,0,1},{4,0,1},{5,0,1},{6,0,1},{7,0,1},{8,0,1},{15,15,0},{16,16,0},{17,17,0},{9,0,1},{10,0,10},{11,0,11},{12,0,12},{13,0,13},{14,0,14},{15,0,15},{16,0,16},{17,0,17},{18,0,18},{19,0,19},{20,0,10},{21,0,11},{22,0,12},{23,0,13},{24,0,14},{25,0,15},{26,0,16},{27,0,17},{28,0,18},{29,0,19},{18,18,0},{19,19,0},{20,10,0},{21,11,0},{22,12,0},{30,0,10},{31,0,11},{32,0,12},{33,0,13},{34,0,14},{35,0,15},{36,0,16},{37,0,17},{38,0,18},{39,0,19},{40,0,10},{41,0,11},{42,0,12},{43,0,13},{44,0,14},{45,0,15},{46,0,16},{47,0,17},{48,0,18},{49,0,19},{50,0,10},{51,0,11},{52,0,12},{53,0,13},{54,0,14},{55,0,15},{56,0,16},{57,0,17},{58,0,18},{23,13,0},{24,14,0},{25,15,0},{26,16,0},{27,17,0},{28,18,0},{59,0,19},{60,0,10},{61,0,11},{62,0,12},{63,0,13},{64,0,14},{29,19,0},{30,10,0},{31,11,0},{32,12,0},{33,13,0},{34,14,0},{35,15,0},{36,16,0},{37,17,0},{38,18,0},{39,19,0},{40,10,0},{41,11,0},{42,12,0},{43,13,0},{44,14,0},{45,15,0},{46,16,0},{47,17,0},{48,18,0},{49,19,0},{50,10,0},{51,11,0},{52,12,0},{53,13,0},{54,14,0},{55,15,0},{56,16,0},{57,17,0},{58,18,0},{59,19,0},{60,10,0},{61,11,0},{62,12,0},{63,13,0},{64,14,0},{1,1,1},{2,1,1},{3,1,1},{4,1,1},{5,1,1},{6,1,1},{7,1,1},{8,1,1},{9,1,1},{10,10,10},{11,11,11},{12,12,12},{13,13,13},{14,14,14},{15,15,15},{16,16,16},{17,17,17},{18,18,18},{19,19,19},{20,10,10},{21,11,11},{22,12,12},{23,13,13},{24,14,14},{25,15,15},{26,16,16},{27,17,17},{28,18,18},{29,19,19},{30,10,10},{31,11,11},{32,12,12},{33,13,13},{34,14,14},{35,15,15},{36,16,16},{37,17,17},{38,18,18},{39,19,19},{40,10,10},{41,11,11},{42,12,12},{43,13,13},{44,14,14},{45,15,15},{46,16,16},{47,17,17},{48,18,18},{49,19,19},{50,10,10},{51,11,11},{52,12,12},{53,13,13},{54,14,14},{55,15,15},{56,16,16},{57,17,17},{58,18,18},{59,19,19},{60,10,10},{61,11,11},{62,12,12},{63,13,13},{64,14,14}};

static const AmplitudeTable AC_AMPLITUDE_TABLE_1252[] =
{{1,0,0},{1,1,0},{2,0,0},{3,0,0},{2,1,0},{0,0,0},{4,0,0},{5,0,0},{6,0,0},{7,0,0},{3,1,0},{8,0,0},{9,0,0},{10,0,0},{11,0,0},{12,0,0},{13,0,0},{14,0,0},{4,1,0},{5,1,0},{15,0,0},{16,0,0},{17,0,0},{18,0,0},{6,1,0},{19,0,0},{20,0,0},{21,0,0},{22,0,0},{23,0,0},{24,0,0},{7,1,0},{8,1,0},{25,0,0},{26,0,0},{27,0,0},{28,0,0},{29,0,0},{30,0,0},{31,0,0},{32,0,0},{9,1,0},{10,10,0},{33,0,0},{34,0,0},{35,0,0},{36,0,0},{37,0,0},{38,0,0},{39,0,0},{40,0,0},{41,0,0},{11,11,0},{12,12,0},{13,13,0},{42,0,0},{43,0,0},{44,0,0},{45,0,0},{46,0,0},{47,0,0},{48,0,0},{49,0,0},{50,0,0},{51,0,0},{52,0,0},{53,0,0},{14,14,0},{15,15,0},{16,16,0},{54,0,0},{55,0,0},{56,0,0},{57,0,0},{58,0,0},{59,0,0},{60,0,0},{61,0,0},{62,0,0},{63,0,0},{64,0,0},{1,0,1},{2,0,1},{3,0,1},{17,17,0},{18,18,0},{19,19,0},{20,10,0},{4,0,1},{5,0,1},{6,0,1},{7,0,1},{8,0,1},{9,0,1},{10,0,10},{11,0,11},{12,0,12},{13,0,13},{14,0,14},{15,0,15},{16,0,16},{17,0,17},{18,0,18},{19,0,19},{20,0,10},{21,0,11},{21,11,0},{22,12,0},{23,13,0},{24,14,0},{25,15,0},{22,0,12},{23,0,13},{24,0,14},{25,0,15},{26,0,16},{27,0,17},{28,0,18},{29,0,19},{30,0,10},{31,0,11},{32,0,12},{33,0,13},{34,0,14},{35,0,15},{36,0,16},{37,0,17},{38,0,18},{39,0,19},{40,0,10},{41,0,11},{42,0,12},{43,0,13},{44,0,14},{45,0,15},{46,0,16},{47,0,17},{48,0,18},{49,0,19},{50,0,10},{51,0,11},{52,0,12},{53,0,13},{54,0,14},{55,0,15},{56,0,16},{57,0,17},{58,0,18},{59,0,19},{60,0,10},{61,0,11},{62,0,12},{63,0,13},{64,0,14},{26,16,0},{27,17,0},{28,18,0},{29,19,0},{30,10,0},{31,11,0},{32,12,0},{33,13,0},{34,14,0},{35,15,0},{36,16,0},{37,17,0},{38,18,0},{39,19,0},{40,10,0},{41,11,0},{42,12,0},{43,13,0},{44,14,0},{45,15,0},{46,16,0},{47,17,0},{48,18,0},{49,19,0},{50,10,0},{51,11,0},{52,12,0},{53,13,0},{54,14,0},{55,15,0},{56,16,0},{57,17,0},{58,18,0},{59,19,0},{60,10,0},{61,11,0},{62,12,0},{63,13,0},{64,14,4},{1,1,1},{2,1,1},{3,1,1},{4,1,1},{5,1,1},{6,1,1},{7,1,1},{8,1,1},{9,1,1},{10,10,10},{11,11,11},{12,12,12},{13,13,13},{14,14,14},{15,15,15},{16,16,16},{17,17,17},{18,18,18},{19,19,19},{20,10,10},{21,11,11},{22,12,12},{23,13,13},{24,14,14},{25,15,15},{26,16,16},{27,17,17},{28,18,18},{29,19,19},{30,10,10},{31,11,11},{32,12,12},{33,13,13},{34,14,14},{35,15,15},{36,16,16},{37,17,17},{38,18,18},{39,19,19},{40,10,10},{41,11,11},{42,12,12},{43,13,13},{44,14,14},{45,15,15},{46,16,16},{47,17,17},{48,18,18},{49,19,19},{50,10,10},{51,11,11},{52,12,12},{53,13,13},{54,14,14},{55,15,15},{56,16,16},{57,17,17},{58,18,18},{59,19,19},{60,10,10},{61,11,11},{62,12,12},{63,13,13},{64,14,14}};



typedef struct
{
    uint32_t id;
    int progressive_scan_type;
    uint16_t samples_per_line;
    uint16_t active_lines;
    uint8_t sample_bit_depth;
    unsigned int compressed_frame_size;
    unsigned int coding_unit_size;
    unsigned int compressed_payload_size;
    unsigned int num_macro_blocks_per_scanline;
    unsigned int num_scanline_per_framefield;
    int index_bits;
    const VLCTable *dc_vlc_table;
    size_t dc_vlc_table_size;
    const VLCTable *ac_vlc_table;
    size_t ac_vlc_table_size;
    const AmplitudeTable *ac_amplitude_table;
    size_t ac_amplitude_table_size;
    const VLCTable *ac_run_vlc_table;
    size_t ac_run_vlc_table_size;
    const uint8_t *ac_run_table;
    size_t ac_run_table_size;
} VC3CompParams;

#define VLCTABLE_SIZE(a) (sizeof(a) / sizeof(VLCTable))

static const VC3CompParams VC3_COMP_PARAMS[] =
{
    {1235,  1,  1920,   1080,   10, 917504, 917504, 916860, 120,    68, 6,
        DC_VLC_TABLE_1235, VLCTABLE_SIZE(DC_VLC_TABLE_1235),
        AC_VLC_TABLE_1235, VLCTABLE_SIZE(DC_VLC_TABLE_1235),
        AC_AMPLITUDE_TABLE_1235, VLCTABLE_SIZE(AC_AMPLITUDE_TABLE_1235),
        AC_RUN_VLC_TABLE_1235, VLCTABLE_SIZE(AC_RUN_VLC_TABLE_1235),
        AC_RUN_TABLE_1235, VLCTABLE_SIZE(AC_RUN_TABLE_1235)},
    {1237,  1,  1920,   1080,   8,  606208, 606208, 605564, 120,    68, 4,
        DC_VLC_TABLE_1237, VLCTABLE_SIZE(DC_VLC_TABLE_1237),
        AC_VLC_TABLE_1237, VLCTABLE_SIZE(AC_VLC_TABLE_1237),
        AC_AMPLITUDE_TABLE_1237, VLCTABLE_SIZE(AC_AMPLITUDE_TABLE_1237),
        AC_RUN_VLC_TABLE_1237, VLCTABLE_SIZE(AC_RUN_VLC_TABLE_1237),
        AC_RUN_TABLE_1237, VLCTABLE_SIZE(AC_RUN_TABLE_1237)},
    {1238,  1,  1920,   1080,   8,  917504, 917504, 916860, 120,    68, 4,
        DC_VLC_TABLE_1238, VLCTABLE_SIZE(DC_VLC_TABLE_1238),
        AC_VLC_TABLE_1238, VLCTABLE_SIZE(AC_VLC_TABLE_1238),
        AC_AMPLITUDE_TABLE_1238, VLCTABLE_SIZE(AC_AMPLITUDE_TABLE_1238),
        AC_RUN_VLC_TABLE_1238, VLCTABLE_SIZE(AC_RUN_VLC_TABLE_1238),
        AC_RUN_TABLE_1238, VLCTABLE_SIZE(AC_RUN_TABLE_1238)},
    {1241,  0,  1920,   540,    10, 917504, 458752, 458108, 120,    34, 6,
        DC_VLC_TABLE_1235, VLCTABLE_SIZE(DC_VLC_TABLE_1235),
        AC_VLC_TABLE_1235, VLCTABLE_SIZE(AC_VLC_TABLE_1235),
        AC_AMPLITUDE_TABLE_1235, VLCTABLE_SIZE(AC_AMPLITUDE_TABLE_1235),
        AC_RUN_VLC_TABLE_1235, VLCTABLE_SIZE(AC_RUN_VLC_TABLE_1235),
        AC_RUN_TABLE_1235, VLCTABLE_SIZE(AC_RUN_TABLE_1235)},
    {1242,  0,  1920,   540,    8,  606208, 303104, 302460, 120,    34, 4,
        DC_VLC_TABLE_1237, VLCTABLE_SIZE(DC_VLC_TABLE_1237),
        AC_VLC_TABLE_1237, VLCTABLE_SIZE(AC_VLC_TABLE_1237),
        AC_AMPLITUDE_TABLE_1237, VLCTABLE_SIZE(AC_AMPLITUDE_TABLE_1237),
        AC_RUN_VLC_TABLE_1237, VLCTABLE_SIZE(AC_RUN_VLC_TABLE_1237),
        AC_RUN_TABLE_1237, VLCTABLE_SIZE(AC_RUN_TABLE_1237)},
    {1243,  0,  1920,   540,    8,  917504, 458752, 458108, 120,    34, 4,
        DC_VLC_TABLE_1238, VLCTABLE_SIZE(DC_VLC_TABLE_1238),
        AC_VLC_TABLE_1238, VLCTABLE_SIZE(AC_VLC_TABLE_1238),
        AC_AMPLITUDE_TABLE_1238, VLCTABLE_SIZE(AC_AMPLITUDE_TABLE_1238),
        AC_RUN_VLC_TABLE_1238, VLCTABLE_SIZE(AC_RUN_VLC_TABLE_1238),
        AC_RUN_TABLE_1238, VLCTABLE_SIZE(AC_RUN_TABLE_1238)},
    {1250,  1,  1280,   720,    10, 458752, 458752, 458108, 80,     45, 6,
        DC_VLC_TABLE_1250, VLCTABLE_SIZE(DC_VLC_TABLE_1250),
        AC_VLC_TABLE_1250, VLCTABLE_SIZE(AC_VLC_TABLE_1250),
        AC_AMPLITUDE_TABLE_1250, VLCTABLE_SIZE(AC_AMPLITUDE_TABLE_1250),
        AC_RUN_VLC_TABLE_1250, VLCTABLE_SIZE(AC_RUN_VLC_TABLE_1250),
        AC_RUN_TABLE_1250, VLCTABLE_SIZE(AC_RUN_TABLE_1250)},
    {1251,  1,  1280,   720,    8,  458752, 458752, 458108, 80,     45, 4,
        DC_VLC_TABLE_1251, VLCTABLE_SIZE(DC_VLC_TABLE_1251),
        AC_VLC_TABLE_1251, VLCTABLE_SIZE(AC_VLC_TABLE_1251),
        AC_AMPLITUDE_TABLE_1251, VLCTABLE_SIZE(AC_AMPLITUDE_TABLE_1251),
        AC_RUN_VLC_TABLE_1251, VLCTABLE_SIZE(AC_RUN_VLC_TABLE_1251),
        AC_RUN_TABLE_1251, VLCTABLE_SIZE(AC_RUN_TABLE_1251)},
    {1252,  1,  1280,   720,    8,  303104, 303104, 302460, 80,     45, 4,
        DC_VLC_TABLE_1252, VLCTABLE_SIZE(DC_VLC_TABLE_1252),
        AC_VLC_TABLE_1252, VLCTABLE_SIZE(AC_VLC_TABLE_1252),
        AC_AMPLITUDE_TABLE_1252, VLCTABLE_SIZE(AC_AMPLITUDE_TABLE_1252),
        AC_RUN_VLC_TABLE_1252, VLCTABLE_SIZE(AC_RUN_VLC_TABLE_1252),
        AC_RUN_TABLE_1252, VLCTABLE_SIZE(AC_RUN_TABLE_1252)},
    {1253,  1,  1920,   1080,   8,  188416, 188416, 187772, 120,    68, 4,
        DC_VLC_TABLE_1237, VLCTABLE_SIZE(DC_VLC_TABLE_1237),
        AC_VLC_TABLE_1237, VLCTABLE_SIZE(AC_VLC_TABLE_1237),
        AC_AMPLITUDE_TABLE_1237, VLCTABLE_SIZE(AC_AMPLITUDE_TABLE_1237),
        AC_RUN_VLC_TABLE_1237, VLCTABLE_SIZE(AC_RUN_VLC_TABLE_1237),
        AC_RUN_TABLE_1237, VLCTABLE_SIZE(AC_RUN_TABLE_1237)},
};


typedef struct
{
    int do_payload_dump;
    int do_macroblock_dump;
    
    FILE *in_file;
    FILE *dump_file;
    
    const VC3CompParams *comp_params;
    
    unsigned int num_macro_block_scan_indices;
    uint32_t macro_block_scan_indices[68];
    
    int coding_unit_count;
} VC3Data;



static const unsigned char HEADER_PREFIX[5] = {0x00, 0x00, 0x02, 0x80, 0x01};



static int set_compression_params(VC3Data *data, uint32_t id)
{
    size_t i;
    for (i = 0; i < sizeof(VC3_COMP_PARAMS) / sizeof(VC3CompParams); i++) {
        if (VC3_COMP_PARAMS[i].id == id) {
            data->comp_params = &VC3_COMP_PARAMS[i];
            return 1;
        }
    }
    
    data->comp_params = NULL;
    return 0;
}

static void dump_compression_params(VC3Data *data)
{
    if (!data->comp_params) {
        fprintf(data->dump_file, "<unknown>");
        return;
    }
    
    fprintf(data->dump_file, "SST=%s", data->comp_params->progressive_scan_type ? "progressive" : "interlaced");
    fprintf(data->dump_file, ", SPL=%d", data->comp_params->samples_per_line);
    fprintf(data->dump_file, ", ALPFi=%d", data->comp_params->active_lines);
    fprintf(data->dump_file, ", SBDF=%d", data->comp_params->sample_bit_depth);
    fprintf(data->dump_file, ", comp size=%d", data->comp_params->compressed_frame_size);
    fprintf(data->dump_file, ", coding unit size=%d", data->comp_params->coding_unit_size);
    fprintf(data->dump_file, ", comp payload size=%d", data->comp_params->compressed_payload_size);
}

static size_t read_bytes_s(VC3Data *data, unsigned char *buffer, size_t size)
{
    return fread(buffer, 1, size, data->in_file);
}

static int read_bytes(VC3Data *data, unsigned char *buffer, size_t size)
{
    return fread(buffer, 1, size, data->in_file) == size;
}

static int skip_bytes(VC3Data *data, size_t size)
{
    return fseeko(data->in_file, size, SEEK_CUR) == 0;
}

static int read_u8(VC3Data *data, uint8_t *u8)
{
    int result = fgetc(data->in_file);
    if (result == EOF)
        return 0;
    
    *u8 = (uint8_t)result;
    return 1;
}

static int read_u16be(VC3Data *data, uint16_t *u16)
{
    unsigned char buffer[2];
    if (!read_bytes(data, buffer, 2))
        return 0;
    
    *u16 = (((uint16_t)buffer[0]) << 8) | (uint16_t)buffer[1];
    return 1;
}

static int read_u32be(VC3Data *data, uint32_t *u32)
{
    unsigned char buffer[4];
    if (!read_bytes(data, buffer, 4))
        return 0;
    
    *u32 = (((uint32_t)buffer[0]) << 24) |
           (((uint32_t)buffer[1]) << 16) |
           (((uint32_t)buffer[2]) << 8)  |
             (uint32_t)buffer[3];
    return 1;
}

static void parse_macro_block_scan_indices(VC3Data *data, unsigned char *buffer, size_t size)
{
    size_t i;
    for (i = 0; i < size / 4; i++) {
        data->macro_block_scan_indices[i] = 
                (((uint32_t)buffer[i * 4    ]) << 24) |
                (((uint32_t)buffer[i * 4 + 1]) << 16) |
                (((uint32_t)buffer[i * 4 + 2]) << 8)  |
                  (uint32_t)buffer[i * 4 + 3];
    }
    
    data->num_macro_block_scan_indices = size / 4;
}

static unsigned int get_bits(unsigned char *buffer, unsigned int *bit_pos, unsigned int size)
{
    unsigned int bits = 0;
    unsigned int bit_count = 0;
    unsigned int bits_in_byte, rem_bits_in_byte;
    
    assert(size <= 32);
    
    while (bit_count < size) {
        rem_bits_in_byte = 8 - (((*bit_pos) + bit_count) % 8);
        bits_in_byte = rem_bits_in_byte;
        if (bits_in_byte > size - bit_count)
            bits_in_byte = size - bit_count;
        
        bits <<= bits_in_byte;
        bits |= (buffer[((*bit_pos) + bit_count) / 8] >> (rem_bits_in_byte - bits_in_byte)) &
                    ((1 << bits_in_byte) - 1);
        
        bit_count += bits_in_byte;
    }
    
    *bit_pos += size;
    
    return bits;
}

static uint16_t get_vlc(unsigned char *buffer, unsigned int *bit_pos, const VLCTable *dc_vlc_table, size_t table_size)
{
    uint16_t codeword = 0;
    unsigned int next_bit_pos = *bit_pos;
    size_t i, j;
    
    for (i = 0; i < 16; i++) {
        codeword <<= 1;
        if (buffer[next_bit_pos >> 3] & (1 << (7 - (next_bit_pos % 8))))
            codeword |= 1;
        next_bit_pos++;
        
        for (j = 0; j < table_size; j++) {
            if (codeword == dc_vlc_table[j].codeword && (next_bit_pos - (*bit_pos)) == dc_vlc_table[j].codeword_size) {
                *bit_pos = next_bit_pos;
                return j;
            }
        }
    }
    
    assert(0);
    return 0;
}

static void dump_bytes(FILE *file, unsigned char *buffer, size_t size)
{
    size_t i;
    for (i = 0; i < size; i++) {
        if (i == 0)
            fprintf(file, "%06zx:  ", i);
        else if (i % 16 == 0)
            fprintf(file, "\n%06zx:  ", i);
        else
            fprintf(file, " ");
        fprintf(file, "%02x", buffer[i]);
    }
}

static void dump_bytes_inline(FILE *file, unsigned char *buffer, size_t size)
{
    size_t i;
    for (i = 0; i < size; i++) {
        if (i != 0)
            fprintf(file, " ");
        fprintf(file, "%02x", buffer[i]);
    }
}

static void dump_u32_array(FILE *file, unsigned char *buffer, size_t size)
{
    uint32_t offset;
    size_t i;
    for (i = 0; i < size / 4; i++) {
        offset = (((uint32_t)buffer[4 * i    ]) << 24) |
                 (((uint32_t)buffer[4 * i + 1]) << 16) |
                 (((uint32_t)buffer[4 * i + 2]) << 8)  |
                   (uint32_t)buffer[4 * i + 3];

        if (i == 0)
            fprintf(file, "%06zx:  ", i);
        else if (i % 8 == 0)
            fprintf(file, "\n%06zx:  ", i);
        else
            fprintf(file, " ");
        fprintf(file, "%08x", offset);
    }
}

static void dump_timecode(VC3Data *data, unsigned char *buffer, size_t size)
{
    assert(size == 8);
    
    int hour, min, sec, frame;
    size_t i;
    
    frame = (buffer[0] & 0x0f) + (buffer[1] & 0x03) * 10;
    sec = (buffer[2] & 0x0f) + (buffer[3] & 0x07) * 10;
    min = (buffer[4] & 0x0f) + (buffer[5] & 0x07) * 10;
    hour = (buffer[6] & 0x0f) + (buffer[7] & 0x03) * 10;
    
    fprintf(data->dump_file, "TC=%02d:%02d:%02d:%02d", hour, min, sec, frame);
    fprintf(data->dump_file, ", Color Frame=%s", (buffer[1] & 0x08) ? "true" : "false");
    fprintf(data->dump_file, ", Drop Frame=%s", (buffer[1] & 0x04) ? "true" : "false");
    fprintf(data->dump_file, ", Field Id=%d", buffer[3] & 0x08);
    
    fprintf(data->dump_file, ", BG=");
    for (i = 0; i < 8; i++)
        fprintf(data->dump_file, " %02x", buffer[i] >> 8);
}

static int dump_header(VC3Data *data)
{
    unsigned char buffer[272];
    uint8_t u8;
    uint16_t u16;
    uint32_t u32;
    uint16_t mbsi_count;
    size_t numread;
    int have_timecode;
    int have_user_data;
    
    
    /* header prefix (5) */
    
    numread = read_bytes_s(data, buffer, 5);
    if (numread != 5) {
        if (!feof(data->in_file)) {
            fprintf(stderr, "Error: Failed to read from file: %s\n", strerror(errno));
        } else if (numread != 0) {
            fprintf(stderr, "Error: Trailing bytes: ");
            dump_bytes_inline(data->dump_file, buffer, numread);
            fprintf(stderr, "\n");
        }
        return 0;
    }
    fprintf(data->dump_file, "Header prefix: ");
    if (memcmp(buffer, HEADER_PREFIX, 5) != 0) {
        REPORT_INVALID_DATA("Invalid header prefix", -5);
        return 0;
    }
    dump_bytes_inline(data->dump_file, buffer, 5);
    fprintf(data->dump_file, "\n");
    
    
    /* coding control A (3) */

    fprintf(data->dump_file, "Coding control A: ");
    CHECK(read_bytes(data, buffer, 3));
    if ((buffer[0] & 0xfc) != 0x00 || (buffer[1] & 0xef) != 0x80 || (buffer[2] != 0xa0))
        REPORT_INVALID_DATA("Invalid fixed coding control A bits", -3);
    if ((buffer[0] & 0x03) == 0x01)
        fprintf(data->dump_file, "progressive");
    else if ((buffer[0] & 0x03) == 0x02)
        fprintf(data->dump_file, "field 1");
    else if ((buffer[0] & 0x03) == 0x03)
        fprintf(data->dump_file, "field 2");
    else
        REPORT_INVALID_DATA("Invalid FFC", -3);
    if (buffer[1] & 0x10)
        fprintf(data->dump_file, ", CRC");
    fprintf(data->dump_file, "\n");

    
    /* reserved (16) */
    
    CHECK(read_bytes(data, buffer, 16));
    
    
    /* image geometry (11) */
    
    fprintf(data->dump_file, "Image geometry:\n");
    CHECK(read_u16be(data, &u16));
    fprintf(data->dump_file, " ALPF (active lines per frame): %u\n", u16);
    CHECK(read_u16be(data, &u16));
    fprintf(data->dump_file, " SPL (samples per line): %u\n", u16);
    CHECK(read_u8(data, &u8));
    if (u8 != 0x00)
        REPORT_INVALID_DATA("Null SPL", -1);
    CHECK(read_u16be(data, &u16));
    fprintf(data->dump_file, " NAL (number active lines): %u\n", u16);
    CHECK(read_u16be(data, &u16));
    if (u16 != 0x00)
        REPORT_INVALID_DATA("Null NAL", -2);
    CHECK(read_u8(data, &u8));
    if ((u8 & 0x1f) != 0x18)
        REPORT_INVALID_DATA("Invalid SBD bits", -1);
    fprintf(data->dump_file, " SBD (sample bit depth): ");
    if ((u8 & 0xe0) == 0x40)
        fprintf(data->dump_file, "10 bit");
    else if ((u8 & 0xe0) == 0x20)
        fprintf(data->dump_file, "8 bit");
    else
        REPORT_INVALID_DATA("Invalid SBD", -1);
    fprintf(data->dump_file, "\n");
    CHECK(read_u8(data, &u8));
    if ((u8 & 0xfb) != 0x88)
        REPORT_INVALID_DATA("Invalid SST", -1);
    fprintf(data->dump_file, " SST (scan source type): ");
    if (u8 & 0x04)
        fprintf(data->dump_file, "interlaced");
    else
        fprintf(data->dump_file, "progressive");
    fprintf(data->dump_file, "\n");
    
    
    /* reserved (5) */
    
    CHECK(read_bytes(data, buffer, 5));
    
    
    /* compression id (4) */
    
    fprintf(data->dump_file, "CID (compression id): ");
    CHECK(read_u32be(data, &u32));
    fprintf(data->dump_file, "%u ", u32);
    CHECK(set_compression_params(data, u32));
    fprintf(data->dump_file, "(");
    dump_compression_params(data);
    fprintf(data->dump_file, ")\n");


    /* coding control B (1) */

    fprintf(data->dump_file, "Coding control B: ");
    CHECK(read_u8(data, &u8));
    if ((u8 & 0x7f) != 0x00)
        REPORT_INVALID_DATA("Invalid coding control B", -1);
    if (u8 & 0x80)
        fprintf(data->dump_file, "frame encoding");
    else
        fprintf(data->dump_file, "field encoding");
    fprintf(data->dump_file, "\n");

    
    /* reserved (3) */
    
    CHECK(read_bytes(data, buffer, 3));
    
    
    /* timecode control (1) */
    
    fprintf(data->dump_file, "Timecode control: ");
    CHECK(read_u8(data, &u8));
    if ((u8 & 0x7f) != 0x00)
        REPORT_INVALID_DATA("Invalid timecode control", -1);
    have_timecode = ((u8 & 0x80) != 0);
    if (have_timecode)
        fprintf(data->dump_file, "present");
    else
        fprintf(data->dump_file, "not present");
    fprintf(data->dump_file, "\n");


    /* timecode (8) */

    if (have_timecode)
        fprintf(data->dump_file, "Timecode: ");
    CHECK(read_bytes(data, buffer, 8));
    if (have_timecode) {
        dump_timecode(data, buffer, 8);
        fprintf(data->dump_file, "\n");
    }

    
    /* reserved (38) */
    
    CHECK(read_bytes(data, buffer, 38));
    
    
    /* user data control (1) */
    
    fprintf(data->dump_file, "User data control: ");
    CHECK(read_u8(data, &u8));
    if ((u8 & 0x0f) != 0x01)
        REPORT_INVALID_DATA("Invalid user data control", -1);
    have_user_data = (u8 >> 4);
    if (have_user_data)
        fprintf(data->dump_file, "label 0x%04x\n", u8 >> 4);
    else
        fprintf(data->dump_file, "not present\n");


    /* user data payload (260) */

    if (have_user_data)
        fprintf(data->dump_file, "User data payload: \n");
    CHECK(read_bytes(data, buffer, 260));
    if (have_user_data) {
        dump_bytes(data->dump_file, buffer, 260);
        fprintf(data->dump_file, "\n");
    }

    
    /* reserved (3) */
    
    CHECK(read_bytes(data, buffer, 3));
    
    
    /* macro block scan indices control (9) */

    fprintf(data->dump_file, "Macro block scan indices control: ");
    CHECK(read_bytes(data, buffer, 3));
    if (buffer[0] != 0x02 || buffer[1] != 0x00 || buffer[2] != 0x00)
        REPORT_INVALID_DATA("Invalid macro block indices control bits", -3);
    CHECK(read_u16be(data, &u16));
    fprintf(data->dump_file, "size %d (%d bytes)", (u16 - 4) / 4, u16 - 4);
    mbsi_count = u16 - 4;
    if (mbsi_count > 272)
        REPORT_INVALID_DATA("Macro block indices count exceeds 272", -2);
    CHECK(read_bytes(data, buffer, 1));
    if (buffer[0] != 0x00)
        REPORT_INVALID_DATA("Invalid macro block indices control bits", -1);
    CHECK(read_u8(data, &u8));
    fprintf(data->dump_file, ", num scan lines %d\n", u8);
    if (u8 != data->comp_params->num_scanline_per_framefield)
        REPORT_INVALID_DATA("Invalid num scan lines for macro block indices", -1);
    CHECK(read_bytes(data, buffer, 2));
    if (buffer[0] != 0x00 || buffer[1] != 0x10)
        REPORT_INVALID_DATA("Invalid macro block indices control bits", -2);


    /* macro block scan indices (272) */

    fprintf(data->dump_file, "Macro block scan indices: \n");
    CHECK(read_bytes(data, buffer, 272));
    if (mbsi_count <= 272) {
        dump_u32_array(data->dump_file, buffer, mbsi_count);
        fprintf(data->dump_file, "\n");
#if 0        
        fprintf(data->dump_file, " (padding)\n");
        dump_u32_array(data->dump_file, buffer + mbsi_count, 272 - mbsi_count);
        fprintf(data->dump_file, "\n");
#endif
        parse_macro_block_scan_indices(data, buffer, mbsi_count);
    } else {
        dump_bytes(data->dump_file, buffer, 272);
        fprintf(data->dump_file, "\n");
    }

    return 1;
}

static int dump_payload(VC3Data *data)
{
    if (!data->do_payload_dump) {
        CHECK(skip_bytes(data, data->comp_params->compressed_payload_size));
        return 1;
    }
    
    unsigned char buffer[916860];
    unsigned int i, j, k, l;
    unsigned int qsf;
    unsigned int bit_pos = 0;
    unsigned int dc_length, dc_value;
    unsigned int amplitude_index, run_index;
    unsigned int amplitude, amplitude_sign;
    
    CHECK(read_bytes(data, buffer, data->comp_params->compressed_payload_size));
    
    if (data->do_macroblock_dump)
        printf("Compressed payload:\n");
    else
        printf("Compressed payload: <skipping>\n");
    
    for (i = 0; i < data->comp_params->num_scanline_per_framefield && i < data->num_macro_block_scan_indices; i++) {
        
        if (data->do_macroblock_dump)
            printf("SL %d:\n", i);
        
        for (j = 0; j < data->comp_params->num_macro_blocks_per_scanline; j++) {
            if (data->do_macroblock_dump)
                printf("MB %d:", j);

            /* macroblock header */
            qsf = get_bits(buffer, &bit_pos, 11);
            if (data->do_macroblock_dump)
                printf(" (qsf=%d)\n", qsf);
            bit_pos += 1; /* skip bit */

            /* DCT block 0 to 7 */
            for (k = 0; k < 8; k++) {
                if (data->do_macroblock_dump)
                    printf("DCT %d:", k);
                
                /* DC codeword */
                dc_length = get_vlc(buffer, &bit_pos, data->comp_params->dc_vlc_table, data->comp_params->dc_vlc_table_size);
                dc_value = dc_length ? get_bits(buffer, &bit_pos, dc_length) : 0;
                if (data->do_macroblock_dump)
                    printf("DC %d, ", dc_value);
                
                if (data->do_macroblock_dump)
                    printf("AC ");
                for (l = 1; ; l++) {
                    amplitude_index = get_vlc(buffer, &bit_pos, data->comp_params->ac_vlc_table, data->comp_params->ac_vlc_table_size);
                    assert(amplitude_index < data->comp_params->ac_amplitude_table_size);
                    amplitude = data->comp_params->ac_amplitude_table[amplitude_index].amplitude;
                    
                    if (amplitude == 0) {
                        if (data->do_macroblock_dump)
                            printf("EOB");
                        break;
                    }

                    if (l >= 64) {
                        REPORT_INVALID_DATA("AC coefficient count exceeds 63", 0);
                        return 0;
                    }
                    
                    amplitude_sign = get_bits(buffer, &bit_pos, 1);
                    
                    if (data->comp_params->ac_amplitude_table[amplitude_index].index_flag)
                        amplitude += get_bits(buffer, &bit_pos, data->comp_params->index_bits) << 6;

                    if (data->comp_params->ac_amplitude_table[amplitude_index].run_flag) {
                        run_index = get_vlc(buffer, &bit_pos, data->comp_params->ac_run_vlc_table, data->comp_params->ac_run_vlc_table_size);
                        l += data->comp_params->ac_run_table[run_index];
                        if (data->do_macroblock_dump)
                            printf("%d", data->comp_params->ac_run_table[run_index]);
                    } else {
                        if (data->do_macroblock_dump)
                            printf("0");
                    }

                    if (data->do_macroblock_dump)
                        printf("/%s%d,", amplitude_sign ? "-" : "", amplitude);
                }
                if (data->do_macroblock_dump)
                    printf("\n");
            }
        }

        /* skip macroblock scanline padding */
        if ((bit_pos % 32) != 0)
            get_bits(buffer, &bit_pos, 32 - (bit_pos % 32));

        if (data->do_macroblock_dump)
            printf("\n");
    }
    
    printf("Padding: %d bits (%d bytes)\n", 8 * data->comp_params->compressed_payload_size - bit_pos,
                                            data->comp_params->compressed_payload_size - bit_pos / 8);
    
    return 1;
}

static int dump_eof(VC3Data *data)
{
    unsigned char buffer[4];
    
    CHECK(read_bytes(data, buffer, 4));
    fprintf(data->dump_file, "EOF: ");
    dump_bytes_inline(data->dump_file, buffer, 4);
    fprintf(data->dump_file, "\n");

    return 1;
}

static void init_vc3_data(VC3Data *data)
{
    memset(data, 0, sizeof(*data));
}

static void destroy_vc3_data(VC3Data *data)
{
    if (data->in_file)
        fclose(data->in_file);
    if (data->dump_file)
        fclose(data->dump_file);
}

static void usage(const char *cmd)
{
    fprintf(stderr, "Usage: %s [options] <filename>\n", cmd);
    fprintf(stderr, "Options:\n");
    fprintf(stderr, "  -h | --help              Print usage and exit\n");
    fprintf(stderr, "  -p | --no-dump-payload   Don't dump compressed payload data\n");
    fprintf(stderr, "  -m | --dump-mb           Dump detailed macro-block data from compressed payload\n");
}

int main(int argc, const char **argv)
{
    int cmdln_index;
    VC3Data vc3_data;
    const char *filename;
    int do_payload_dump = 1;
    int do_macroblock_dump = 0;
    
    for (cmdln_index = 1; cmdln_index < argc; cmdln_index++) {
        if (strcmp(argv[cmdln_index], "-h") == 0 ||
            strcmp(argv[cmdln_index], "--help") == 0)
        {
            usage(argv[0]);
            return 0;
        }
        else if (strcmp(argv[cmdln_index], "-p") == 0 ||
                 strcmp(argv[cmdln_index], "--no-dump-payload") == 0)
        {
            do_payload_dump = 0;
        }
        else if (strcmp(argv[cmdln_index], "-m") == 0 ||
                 strcmp(argv[cmdln_index], "--dump-mb") == 0)
        {
            do_macroblock_dump = 1;
        }
        else
        {
            break;
        }
    }
    
    if (argc == 1) {
        usage(argv[0]);
        return 0;
    } else if (cmdln_index != argc - 1) {
        usage(argv[0]);
        fprintf(stderr, "Unknown argument '%s'\n", argv[cmdln_index]);
        return 1;
    } else if (cmdln_index > argc - 1) {
        usage(argv[0]);
        fprintf(stderr, "Missing <filename>\n");
        return 1;
    }
    filename = argv[cmdln_index];


    init_vc3_data(&vc3_data);
    vc3_data.do_payload_dump = do_payload_dump;
    vc3_data.do_macroblock_dump = do_macroblock_dump;
    
    vc3_data.dump_file = stdout;
    
    vc3_data.in_file = fopen(filename, "rb");
    if (!vc3_data.in_file) {
        fprintf(stderr, "Failed to open file '%s': %s\n", filename, strerror(errno));
        return 1;
    }
    
    while (1) {
        printf("Coding unit %d\n", vc3_data.coding_unit_count);
        
        if (!dump_header(&vc3_data) || !dump_payload(&vc3_data) || !dump_eof(&vc3_data))
            break;
        
        vc3_data.coding_unit_count++;
    }
    
    destroy_vc3_data(&vc3_data);
    
    return 0;
}
