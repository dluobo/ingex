/*
 * $Id: http_access_resources.c,v 1.3 2009/01/29 07:10:26 stuart_hc Exp $
 *
 *
 *
 * Copyright (C) 2008-2009 British Broadcasting Corporation, All Rights Reserved
 * Author: Philip de Nier
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, write to the Free Software Foundation, Inc.,
 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
 */

#include <pthread.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <inttypes.h>

#include "http_access_resources.h"
#include "macros.h"
#include "logging.h"


#define RESOURCE_ALLOCATION_STEP        10


struct HTTPAccessResources
{
    HTTPAccessResource* resources;
    int numResources;
    int allocatedResources;
};


static const char* g_htmlContentType = "text/html";
static const char* g_imageContentType = "image/png";


static const char* g_PlayerPage =
    "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n"
    "\n"
    "<html>\n"
    "\n"
    "<head>\n"
    "<title>Ingex Player</title>\n"
    "<meta HTTP-EQUIV=\"Content-Type\" CONTENT=\"text/html; charset=iso-8859-1\"/>\n"
    "\n"
    "<script type=\"text/javascript\"><!--\n"
    "	\n"
    "	function send_control(controlType)\n"
    "	{\n"
    "        var request = new XMLHttpRequest();\n"
    "        request.open(\"GET\", \"/player/control/\" + controlType, true);\n"
    "        request.send(null);\n"
    "	}\n"
    "\n"
    "	function handle_keydown(event)\n"
    "	{\n"
    "		switch (event.keyCode)\n"
    "		{\n"
    "			case 250:\n"
    "				send_control(\"play\");\n"
    "				break;\n"
    "			case 19:\n"
    "				send_control(\"pause\");\n"
    "				break;\n"
    "			case 12:\n"
    "				send_control(\"stop\");\n"
    "				break;\n"
    "			case 124:\n"
    "				send_control(\"play-speed?speed=10&unit=FRAME_PLAY_UNIT\");\n"
    "				break;\n"
    "			case 125:\n"
    "				send_control(\"play-speed?speed=-10&unit=FRAME_PLAY_UNIT\");\n"
    "				break;\n"
    "			case 126:\n"
    "				send_control(\"home\");\n"
    "				break;\n"
    "			case 127:\n"
    "				send_control(\"end\");\n"
    "				break;\n"
    "		}\n"
    "	}\n"
    "\n"
    "	\n"
    "	var statusInterval = 1000;\n"
    "	var stateRequest = null;\n"
    "	\n"
    "	\n"
    "	function handleStateContent(event)\n"
    "	{\n"
    "		try\n"
    "		{\n"
    "			if (stateRequest.readyState == 4)\n"
    "			{\n"
    "				if (stateRequest.status != 200)\n"
    "				{\n"
    "					throw \"failed to get player state\";\n"
    "				}\n"
    "				\n"
    "				var result = event.target.responseXML;\n"
    "				var timecodeXEles = result.getElementsByTagName(\"timecode\");\n"
    "				\n"
    "				if (timecodeXEles.length > 0)\n"
    "				{\n"
    "					var timecodeXEle = timecodeXEles[0];\n"
    "					\n"
    "					var timecodeDivEle = document.getElementById(\"timecode\");\n"
    "					if (timecodeDivEle != null)\n"
    "					{\n"
    "						var newEle = document.createElement(\"div\");\n"
    "						var timecodeText = document.createTextNode(timecodeXEle.firstChild.nodeValue);\n"
    "						\n"
    "						newEle.setAttribute(\"id\", \"timecode\");\n"
    "						newEle.appendChild(timecodeText);\n"
    "						\n"
    "						timecodeDivEle.parentNode.replaceChild(newEle, timecodeDivEle);\n"
    "					}\n"
    "				}\n"
    "				\n"
    "				setTimeout(\"get_state()\", statusInterval)\n"
    "			}\n"
    "		} \n"
    "		catch (err)\n"
    "		{\n"
    "			// ignore the error\n"
    "			\n"
    "			setTimeout(\"get_state()\", statusInterval)\n"
    "		}\n"
    "	}\n"
    "	\n"
    "	function get_state()\n"
    "	{\n"
    "		try\n"
    "		{\n"
    "			stateRequest = new XMLHttpRequest();\n"
    "			stateRequest.open(\"GET\", \"/player/state\", false);\n"
    "			stateRequest.onload = handleStateContent;\n"
    "			stateRequest.send(null);\n"
    "		}\n"
    "		catch (err)\n"
    "		{\n"
    "			// ignore the error\n"
    "		}\n"
    "	}\n"
    "\n"
    "-->\n"
    "</script>\n"
    "\n"
    "</head>\n"
    "\n"
    "<body onload=\"get_state()\" onkeydown=\"handle_keydown(event)\">\n"
    "\n"
    "<h1>Ingex Player</h1>\n"
    "\n"
    "<div style=\"font-size: 24pt;\"><div id=\"timecode\">??:??:??:?? </div></div>\n"
    "\n"
    "<table>\n"
    "<tr>\n"
    "<td><img id=\"homesym\" alt=\"Home\" src=\"/resources/home.png\" onclick=\"send_control('home')\"/></td>\n"
    "<td><img id=\"frsym\" alt=\"FastRewind\" src=\"/resources/fastrewind.png\" onclick=\"send_control('play-speed?speed=-10&unit=FRAME_PLAY_UNIT')\"/></td>\n"
    "<td><img id=\"playsym\" alt=\"Play\" src=\"/resources/play.png\" onclick=\"send_control('play')\"/></td>\n"
    "<td><img id=\"pausesym\" alt=\"Pause\" src=\"/resources/pause.png\" onclick=\"send_control('pause')\"/></td>\n"
    "<td><img id=\"stopsym\" alt=\"Stop\" src=\"/resources/stop.png\" onclick=\"send_control('stop')\"/></td>\n"
    "<td><img id=\"ffsym\" alt=\"FastForward\" src=\"/resources/fastforward.png\" onclick=\"send_control('play-speed?speed=10&unit=FRAME_PLAY_UNIT')\"/></td>\n"
    "<td><img id=\"endsym\" alt=\"End\" src=\"/resources/end.png\" onclick=\"send_control('end')\"/></td>\n"
    "</tr>\n"
    "</table>\n"
    "\n"
    "</body>\n"
    "\n"
    "\n"
    "</html>\n"
    "\n"
    "\n"
    "";


static const unsigned char g_PlayImage[] =
{
    0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x0d,0x49,0x48,0x44,0x52,0x00,0x00,0x00,0x3b,
    0x00,0x00,0x00,0x3b,0x08,0x02,0x00,0x00,0x00,0x4a,0x47,0x65,0xe4,0x00,0x00,0x00,0x09,0x70,0x48,0x59,
    0x73,0x00,0x00,0x0f,0x09,0x00,0x00,0x0f,0x09,0x01,0xe1,0xbc,0xcb,0xf1,0x00,0x00,0x01,0x30,0x49,0x44,
    0x41,0x54,0x78,0x9c,0xed,0x99,0xcb,0xaa,0xc4,0x20,0x10,0x05,0x0d,0xe4,0xc3,0xeb,0xcf,0x73,0xef,0xc1,
    0x61,0x96,0x83,0x46,0xfb,0x05,0x9e,0x45,0x65,0x5b,0x88,0xb1,0xdb,0xf6,0x6e,0xa5,0xf2,0x3c,0xcf,0xdd,
    0x3f,0xd1,0x26,0x43,0xb9,0xae,0xeb,0x9f,0x77,0xb4,0xc6,0x74,0x8e,0xb1,0x7d,0x8e,0xb1,0x7d,0x8e,0xb1,
    0x7d,0x8e,0xb1,0x7d,0x86,0x8c,0x7b,0xb1,0x49,0x52,0x1a,0x87,0xd7,0x98,0x2c,0xde,0x33,0xbb,0x02,0x21,
    0xdc,0x7b,0x7e,0x1f,0x23,0x04,0x7a,0xbf,0xfd,0xf3,0x10,0x42,0xbc,0xd7,0xce,0x0a,0x04,0x67,0xef,0x1d,
    0xa7,0x1b,0x82,0x9b,0xf7,0xbe,0xf3,0x18,0xc1,0xc1,0x7b,0x77,0x05,0x41,0x30,0xf5,0xb6,0xa9,0x79,0x08,
    0xdd,0xbb,0xed,0x56,0xb7,0xac,0xd2,0x7c,0xbe,0x7b,0x97,0xdc,0xa5,0xaf,0x40,0xd8,0xe5,0xed,0xd8,0x09,
    0x21,0xac,0x7b,0xbb,0xf7,0x6e,0x08,0x2b,0xde,0x41,0xdd,0x26,0xc2,0x3b,0xef,0xd0,0xfe,0x18,0x61,0xd6,
    0x3b,0x41,0x47,0x8f,0x30,0xee,0x9d,0xc0,0xb8,0x07,0x61,0xc4,0x3b,0x8d,0x71,0x0f,0xc2,0x6f,0xef,0x8c,
    0xc6,0x45,0xd6,0x18,0xa1,0xc8,0x3e,0x46,0x28,0x72,0x56,0x20,0x14,0x39,0x8f,0x11,0x8a,0xd4,0x3c,0x84,
    0x22,0x7d,0x05,0x42,0x91,0xde,0x0d,0xa1,0x48,0x7f,0x8c,0x50,0xe4,0x0e,0x82,0x60,0x71,0xd5,0x33,0x30,
    0x46,0xb0,0xbb,0x4e,0x6f,0x35,0x46,0xb0,0x1e,0x59,0x6c,0x32,0x46,0xf0,0x19,0x0b,0x2d,0x1b,0x23,0x78,
    0x8e,0xde,0x16,0x8c,0x11,0xfc,0xc7,0x9b,0xaf,0x8c,0x11,0xa2,0x46,0xc8,0x93,0xc6,0x08,0xb1,0x63,0xfa,
    0x89,0x57,0x85,0x16,0xed,0xda,0x33,0x6a,0x9c,0xc1,0xb5,0x67,0xc8,0x38,0x8f,0x6e,0x4b,0x71,0x07,0x99,
    0xcc,0x31,0xb6,0xcf,0x31,0xb6,0xcf,0x31,0xb6,0x8f,0x8c,0xbf,0x4f,0x2c,0x25,0x72,0xa7,0xaa,0x0e,0x23,
    0xf9,0x03,0xb8,0x03,0x90,0xae,0x98,0x0d,0x1c,0x9f,0x00,0x00,0x00,0x00,0x49,0x45,0x4e,0x44,0xae,0x42,
    0x60,0x82
};

static const unsigned char g_StopImage[] =
{
    0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x0d,0x49,0x48,0x44,0x52,0x00,0x00,0x00,0x3b,
    0x00,0x00,0x00,0x3b,0x08,0x02,0x00,0x00,0x00,0x4a,0x47,0x65,0xe4,0x00,0x00,0x00,0x09,0x70,0x48,0x59,
    0x73,0x00,0x00,0x0f,0x09,0x00,0x00,0x0f,0x09,0x01,0xe1,0xbc,0xcb,0xf1,0x00,0x00,0x00,0x8f,0x49,0x44,
    0x41,0x54,0x78,0x9c,0xed,0xda,0x41,0x0a,0xc0,0x20,0x0c,0x00,0xc1,0x0a,0xf9,0xff,0x97,0x6d,0xc1,0x0f,
    0x24,0xd0,0xc5,0x28,0x3b,0x07,0xbd,0x2e,0x22,0x28,0xb6,0xf1,0x1c,0x65,0xce,0x19,0x6b,0xda,0x5d,0x92,
    0x32,0xc6,0xf8,0xc6,0xd8,0x9d,0x51,0x66,0x31,0xcf,0x62,0x9e,0xc5,0x3c,0x8b,0x79,0x16,0xf3,0xb2,0xc5,
    0xeb,0x4c,0xe7,0xe4,0xef,0x36,0x85,0x35,0xe6,0xae,0x4b,0xa5,0xc5,0xb8,0x77,0x57,0xf4,0x61,0x31,0xcf,
    0x62,0x9e,0xc5,0x3c,0x8b,0x79,0x16,0xf3,0x2c,0xe6,0x59,0xcc,0xb3,0x98,0x67,0x31,0xcf,0x62,0x9e,0xc5,
    0x3c,0x8b,0x79,0x16,0xf3,0x2c,0xe6,0x5d,0x5d,0xcc,0x3e,0x79,0xa7,0x65,0x8b,0xfb,0xfc,0x1f,0x70,0xf5,
    0xae,0x68,0xc2,0x62,0x9e,0xc5,0x3c,0x8b,0x79,0x67,0x16,0xd3,0xdf,0x9c,0xff,0x15,0x7d,0x8e,0xdf,0xa4,
    0x17,0xf8,0x25,0x10,0xe8,0x8f,0x3c,0x0a,0xe2,0x00,0x00,0x00,0x00,0x49,0x45,0x4e,0x44,0xae,0x42,0x60,
    0x82
};

static const unsigned char g_PauseImage[] =
{
    0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x0d,0x49,0x48,0x44,0x52,0x00,0x00,0x00,0x3b,
    0x00,0x00,0x00,0x3b,0x08,0x02,0x00,0x00,0x00,0x4a,0x47,0x65,0xe4,0x00,0x00,0x00,0x09,0x70,0x48,0x59,
    0x73,0x00,0x00,0x0f,0x09,0x00,0x00,0x0f,0x09,0x01,0xe1,0xbc,0xcb,0xf1,0x00,0x00,0x00,0x9c,0x49,0x44,
    0x41,0x54,0x78,0x9c,0xed,0xda,0xcd,0x0a,0x80,0x20,0x10,0x00,0xe1,0x04,0xdf,0xff,0x95,0xad,0x10,0x3c,
    0xe6,0x06,0x0e,0xfe,0x30,0xdf,0xa1,0x6e,0xcb,0x10,0x52,0x87,0x36,0x5f,0x5b,0x29,0xa5,0xe4,0x7a,0x9b,
    0x5d,0x12,0x92,0x52,0x7a,0xae,0x79,0x76,0xc6,0x6f,0x16,0xf3,0x2c,0xe6,0x59,0xcc,0x3b,0xae,0xb8,0xbe,
    0xb4,0xbb,0xbe,0xbf,0x41,0x43,0x86,0x34,0x91,0x67,0xdc,0x1d,0x14,0x09,0x1a,0x32,0xe4,0x75,0xdc,0xa9,
    0x58,0x90,0xc5,0x3c,0x8b,0x79,0x16,0xf3,0x2c,0xe6,0x59,0xcc,0xb3,0x98,0x67,0x31,0xcf,0x62,0x9e,0xc5,
    0x3c,0x8b,0x79,0x16,0xf3,0x2c,0xe6,0x59,0xcc,0xb3,0x98,0x67,0x31,0xcf,0x62,0x9e,0xc5,0xbc,0x48,0x71,
    0xf4,0x9f,0x0a,0x3f,0xe4,0xd5,0x29,0x1e,0xb2,0x7a,0x31,0x76,0x7f,0xe3,0xcc,0x53,0xb1,0x16,0x8b,0x79,
    0x16,0xf3,0xf6,0x2c,0x0e,0x6e,0x13,0x2c,0x22,0xef,0xb2,0x9e,0xd7,0xdc,0x41,0x9c,0x17,0xe6,0xba,0x43,
    0x19,0x98,0x00,0x00,0x00,0x00,0x49,0x45,0x4e,0x44,0xae,0x42,0x60,0x82
};

static const unsigned char g_FastForwardImage[] =
{
    0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x0d,0x49,0x48,0x44,0x52,0x00,0x00,0x00,0x3b,
    0x00,0x00,0x00,0x3b,0x08,0x02,0x00,0x00,0x00,0x4a,0x47,0x65,0xe4,0x00,0x00,0x00,0x09,0x70,0x48,0x59,
    0x73,0x00,0x00,0x0f,0x09,0x00,0x00,0x0f,0x09,0x01,0xe1,0xbc,0xcb,0xf1,0x00,0x00,0x01,0x1c,0x49,0x44,
    0x41,0x54,0x78,0x9c,0xed,0xda,0xc1,0x0a,0xc4,0x20,0x0c,0x04,0xd0,0x11,0xfc,0xff,0x5f,0x76,0x0b,0x42,
    0x2f,0x85,0xad,0x9a,0x99,0x24,0x16,0xe7,0xb0,0xbd,0x95,0x87,0xb4,0x49,0x5c,0x5b,0xb1,0x55,0x5a,0x6b,
    0xb5,0x5f,0xa2,0x25,0x43,0x29,0xa5,0x5c,0xbf,0x35,0x9a,0x31,0x9d,0x23,0xd6,0xe7,0x88,0xf5,0x39,0x62,
    0x7d,0xbe,0x25,0xbe,0x2a,0x36,0xa5,0xb9,0xb0,0xee,0xd3,0xf3,0xb2,0xc6,0x09,0xd1,0xef,0x4f,0x45,0x36,
    0xf4,0xd0,0x73,0x9c,0x0a,0x3d,0xfa,0xe6,0xe5,0x41,0x4f,0xd4,0x8a,0x3e,0x3a,0xd9,0xdd,0x46,0xf4,0x74,
    0x75,0xa3,0x2c,0xb6,0xe5,0x26,0x2b,0xf5,0x38,0x16,0xbd,0xd8,0x41,0x02,0xd1,0xeb,0x3d,0x2f,0x0a,0x6d,
    0xea,0xd2,0x2c,0x34,0x66,0x5e,0x68,0xeb,0x5c,0xe1,0x5f,0xf5,0x08,0x93,0x90,0x33,0x9a,0x33,0xbb,0x79,
    0xa2,0x69,0xd3,0xa6,0x5b,0x7f,0x21,0xcf,0xc7,0x0e,0x05,0x84,0x3f,0xd1,0xab,0xd1,0x92,0x3d,0x88,0x14,
    0xad,0xda,0x35,0xe9,0xd0,0x2a,0x31,0x6b,0xc7,0xf1,0x44,0x4b,0xc4,0xc4,0x5d,0x9d,0xc7,0x1a,0x4b,0xb9,
    0xa0,0x8b,0xd5,0x5c,0x70,0xc5,0x0e,0x5c,0x10,0xc5,0x3e,0x5c,0xb0,0xc4,0x6e,0x5c,0x50,0xc4,0x9e,0x5c,
    0xd8,0xc5,0xce,0x5c,0x58,0xc4,0xdc,0xf3,0x1e,0xf9,0x1e,0xc4,0x7f,0x69,0xef,0xac,0x88,0x03,0xb9,0x58,
    0x10,0xc7,0x72,0x31,0x2b,0x0e,0xe7,0x62,0x4a,0x9c,0x81,0x8b,0x71,0x71,0x12,0x2e,0x06,0xc5,0x79,0xb8,
    0x18,0x11,0xa7,0xe2,0xe2,0x55,0x9c,0x8d,0x8b,0xff,0xe2,0x84,0x5c,0xf8,0x9c,0xe7,0x71,0xfb,0xf9,0xb7,
    0x4e,0x20,0x73,0xe6,0x88,0xf5,0x39,0x62,0x7d,0xf6,0x14,0xf7,0x3f,0xab,0x77,0x49,0xdd,0xe5,0xf3,0xbc,
    0x3b,0x3f,0x04,0x2b,0xf6,0x72,0xb6,0x91,0x76,0xe6,0x00,0x00,0x00,0x00,0x49,0x45,0x4e,0x44,0xae,0x42,
    0x60,0x82
};

static const unsigned char g_FastRewindImage[] =
{
    0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x0d,0x49,0x48,0x44,0x52,0x00,0x00,0x00,0x3b,
    0x00,0x00,0x00,0x3b,0x08,0x02,0x00,0x00,0x00,0x4a,0x47,0x65,0xe4,0x00,0x00,0x00,0x09,0x70,0x48,0x59,
    0x73,0x00,0x00,0x0f,0x09,0x00,0x00,0x0f,0x09,0x01,0xe1,0xbc,0xcb,0xf1,0x00,0x00,0x01,0x1f,0x49,0x44,
    0x41,0x54,0x78,0x9c,0xed,0xda,0x49,0x0e,0x85,0x20,0x10,0x04,0xd0,0x22,0xe1,0xfe,0x57,0xf6,0x9b,0x98,
    0xfc,0x85,0x22,0x43,0xd3,0x43,0x11,0xa9,0x85,0xee,0xe0,0xc5,0x28,0x43,0x63,0xc6,0x52,0x39,0x8e,0x23,
    0x5f,0xb7,0x68,0x49,0x57,0x52,0x4a,0xe7,0x35,0x47,0x33,0x86,0xb3,0xc5,0xf6,0xd9,0x62,0xfb,0x6c,0xb1,
    0x7d,0x3e,0x2c,0x3e,0x87,0x77,0x95,0x99,0xa8,0xd9,0x8e,0x8e,0xf8,0x9a,0x8d,0x7c,0xda,0x51,0x10,0x7b,
    0x72,0x31,0x2f,0x76,0xe6,0x62,0x52,0xac,0xc2,0x1d,0x6d,0x44,0x2e,0x0e,0xe1,0x42,0x2c,0x8e,0xe2,0x42,
    0x26,0x0e,0xe4,0x42,0x20,0x8e,0xe5,0x62,0x48,0xec,0x3f,0x2c,0x14,0xd3,0x2b,0x26,0xe1,0xa2,0x53,0xcc,
    0xc3,0x45,0x8f,0x98,0x8a,0x8b,0xa6,0x38,0xfc,0x3b,0x7b,0xa6,0x26,0x26,0xe4,0xa2,0x22,0xe6,0xe4,0xe2,
    0x4d,0x4c,0xcb,0x45,0x51,0xcc,0xcc,0xc5,0x53,0x4c,0xce,0xc5,0x4d,0xac,0xd5,0xd3,0xb9,0xed,0x71,0x7a,
    0xc6,0x8a,0x3d,0xd9,0xa1,0xef,0x6f,0x05,0x3f,0xba,0xf0,0xe5,0x91,0xa3,0xcb,0xa3,0x1b,0x33,0xfa,0x75,
    0x06,0xa1,0x45,0xd7,0x66,0x69,0x4e,0x74,0x63,0x25,0x44,0x88,0x6e,0xaf,0x36,0xd9,0xd0,0x5d,0x2b,0x7a,
    0x2a,0x74,0xef,0xae,0x49,0x17,0x0d,0x9f,0xbd,0xf4,0x64,0x4f,0xcf,0xd6,0x9c,0xea,0x15,0xe1,0x6f,0x88,
    0xa4,0xc2,0x12,0x8b,0x16,0x56,0xb1,0x02,0xd1,0xf2,0x4a,0x61,0x14,0x7a,0xaa,0x1a,0x1b,0x82,0x9e,0xad,
    0x78,0xfb,0xa3,0x15,0x4e,0x15,0x9c,0xd1,0x3a,0x27,0x37,0xea,0xf3,0x4b,0x25,0x6a,0xa7,0x63,0x6e,0x3f,
    0x69,0x7c,0xf8,0x04,0xd2,0x2d,0x5b,0x6c,0x9f,0x2d,0xb6,0xcf,0x9a,0x62,0xd3,0xc2,0x9e,0x7a,0xf2,0x2a,
    0xbf,0xe7,0xfd,0xf3,0x03,0x06,0x30,0x88,0x53,0x4d,0x80,0x5e,0xf7,0x00,0x00,0x00,0x00,0x49,0x45,0x4e,
    0x44,0xae,0x42,0x60,0x82
};

static const unsigned char g_HomeImage[] =
{
    0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x0d,0x49,0x48,0x44,0x52,0x00,0x00,0x00,0x3b,
    0x00,0x00,0x00,0x3b,0x08,0x02,0x00,0x00,0x00,0x4a,0x47,0x65,0xe4,0x00,0x00,0x00,0x09,0x70,0x48,0x59,
    0x73,0x00,0x00,0x0f,0x09,0x00,0x00,0x0f,0x09,0x01,0xe1,0xbc,0xcb,0xf1,0x00,0x00,0x01,0x19,0x49,0x44,
    0x41,0x54,0x78,0x9c,0xed,0xda,0x41,0x0e,0xc2,0x30,0x0c,0x44,0x51,0x57,0xca,0xfd,0xaf,0x5c,0x8a,0x46,
    0xea,0xa2,0x12,0x10,0xc7,0x1e,0x4f,0x22,0xf2,0x17,0xb0,0xe4,0xc9,0x84,0x34,0x40,0x9b,0x2d,0xd5,0x79,
    0x9e,0x0d,0x4f,0x6a,0x49,0x57,0xc7,0x71,0x5c,0x8f,0x4d,0xcd,0x70,0xb7,0xc5,0xfc,0xb6,0x98,0xdf,0x16,
    0xf3,0xeb,0x12,0x63,0x23,0xbc,0xd3,0xee,0xdf,0xd3,0xcd,0xf8,0x9a,0xce,0xf7,0x89,0x4c,0x24,0x7e,0xbc,
    0x93,0x9f,0x9a,0x42,0xdc,0x69,0x45,0x7a,0xb1,0x8b,0x6b,0x5a,0xb1,0xd7,0x8a,0x34,0xe2,0x31,0x2b,0x12,
    0x88,0x23,0x5c,0x2b,0x16,0x07,0xad,0xa8,0x48,0x9c,0x62,0x45,0x74,0x71,0xa2,0x15,0x71,0xc5,0xe9,0x5c,
    0xe3,0x89,0x19,0x56,0x94,0x2f,0xe6,0x59,0x51,0xb2,0x98,0xcd,0xb5,0x44,0x71,0x81,0x15,0x25,0x88,0xcb,
    0xac,0x28,0x2a,0x2e,0xe6,0x5a,0x44,0x5c,0x6f,0x45,0x23,0x62,0x95,0x15,0xe9,0xcf,0xc7,0xde,0xfe,0x43,
    0x8c,0x6f,0x8e,0x2b,0xad,0x63,0xa4,0x72,0x47,0x57,0xc5,0xe5,0x5e,0x6c,0x3f,0xb6,0xf2,0x61,0xa7,0x7d,
    0xf2,0xca,0xdc,0xc9,0x7b,0x45,0xc1,0x22,0xc9,0xdf,0xdd,0xd8,0xc3,0x66,0xed,0xc7,0x3c,0x37,0xf7,0x0a,
    0xc2,0x58,0x24,0xf4,0x6b,0x5e,0xfa,0xb0,0x8b,0xae,0xd2,0x89,0xee,0xd2,0x73,0x45,0x8a,0x5b,0x70,0x12,
    0x0a,0x2e,0x6e,0xcd,0xd9,0x2d,0x32,0x6c,0xe5,0x69,0x73,0xcc,0xad,0x3f,0x1f,0x7b,0x17,0x89,0x5e,0x6c,
    0xce,0x61,0x4f,0x21,0x46,0x9d,0xee,0x2e,0x71,0xe5,0x1f,0x78,0x3f,0x5f,0x6b,0xa2,0x19,0x77,0xb6,0xc5,
    0xfc,0xb6,0x98,0xdf,0x16,0xf3,0x7b,0x8b,0xb5,0xbf,0xfc,0x79,0x6b,0xab,0xdc,0x9e,0x77,0xf7,0x02,0x30,
    0xdd,0x4c,0x1a,0x33,0x22,0x20,0x4e,0x00,0x00,0x00,0x00,0x49,0x45,0x4e,0x44,0xae,0x42,0x60,0x82
};

static const unsigned char g_EndImage[] =
{
    0x89,0x50,0x4e,0x47,0x0d,0x0a,0x1a,0x0a,0x00,0x00,0x00,0x0d,0x49,0x48,0x44,0x52,0x00,0x00,0x00,0x3b,
    0x00,0x00,0x00,0x3b,0x08,0x02,0x00,0x00,0x00,0x4a,0x47,0x65,0xe4,0x00,0x00,0x00,0x09,0x70,0x48,0x59,
    0x73,0x00,0x00,0x0f,0x09,0x00,0x00,0x0f,0x09,0x01,0xe1,0xbc,0xcb,0xf1,0x00,0x00,0x01,0x00,0x49,0x44,
    0x41,0x54,0x78,0x9c,0xed,0x98,0x41,0x0a,0xc5,0x30,0x08,0x44,0x1b,0xc8,0xfd,0xaf,0x9c,0x1f,0x70,0x53,
    0xf8,0x90,0x9a,0xc4,0x51,0x07,0x9c,0x45,0xbb,0x2b,0x0f,0x99,0xea,0x68,0x7f,0xa8,0x34,0xc6,0xe8,0xf2,
    0x8a,0x26,0x51,0xa9,0xb5,0x36,0x9f,0x3d,0x1a,0x63,0x5b,0x45,0x8c,0x57,0x11,0xe3,0x55,0xc4,0x78,0x85,
    0x11,0x4b,0x73,0x7d,0x4b,0x39,0x16,0x56,0xc4,0xf3,0xa3,0x09,0x87,0xcb,0x47,0x8d,0xa5,0x12,0xa9,0xb8,
    0x55,0xae,0x48,0xc5,0xbd,0xe1,0xe3,0x24,0x26,0xd9,0xfb,0xf3,0x32,0x14,0xfb,0xa4,0x57,0xc4,0x72,0x9f,
    0x77,0xb7,0x28,0x93,0x5c,0xf5,0xe3,0x90,0x62,0x1b,0x4c,0x10,0x67,0x6e,0xb3,0x99,0xe7,0x66,0x12,0xcb,
    0x29,0xed,0x53,0x6c,0xfb,0x5c,0x81,0xe6,0x46,0x25,0x21,0x1c,0x37,0x36,0xbb,0x21,0xcc,0x0d,0x4f,0x9b,
    0xe6,0xc5,0x76,0xca,0xc7,0x86,0xdc,0xae,0x89,0xde,0xc4,0x24,0xde,0x3b,0xc8,0x7d,0xb1,0x63,0xb6,0xa6,
    0xff,0x95,0x49,0xaf,0xda,0x4c,0xf1,0x8a,0x21,0x9e,0x3e,0x3e,0x36,0x86,0x37,0x31,0x59,0xaf,0x60,0xea,
    0xc7,0x4c,0x33,0x8f,0x2c,0x57,0x30,0x65,0x37,0xa6,0x7c,0xcc,0xb4,0x83,0x90,0xed,0x79,0x4c,0xbb,0x34,
    0xd3,0xbd,0x82,0xec,0x26,0xc4,0x74,0x77,0x63,0xba,0x6d,0x92,0xdd,0x8f,0x33,0xe0,0x3e,0x4a,0xe2,0x24,
    0xac,0xa2,0x0f,0xe2,0x54,0xac,0xa2,0x15,0x31,0x14,0xf7,0xf8,0xe3,0xb5,0xe7,0xe1,0x55,0xc4,0x78,0x15,
    0x31,0x5e,0x9c,0xc4,0x37,0x77,0x3b,0x7f,0xf5,0x84,0x53,0x6d,0xad,0x1f,0x76,0x0e,0x7e,0xb4,0x70,0x3d,
    0xcb,0x43,0x00,0x00,0x00,0x00,0x49,0x45,0x4e,0x44,0xae,0x42,0x60,0x82
};



int har_create_resources(HTTPAccessResources** resources)
{
    HTTPAccessResources* newResources = NULL;
    HTTPAccessResource resource;

    CALLOC_ORET(newResources, HTTPAccessResources, 1);

    CALLOC_OFAIL(newResources->resources, HTTPAccessResource, RESOURCE_ALLOCATION_STEP);
    newResources->allocatedResources = RESOURCE_ALLOCATION_STEP;

    /* add resources */
    strcpy(resource.name, "player_page");
    strcpy(resource.contentType, g_htmlContentType);
    resource.data = (const unsigned char*)g_PlayerPage;
    resource.dataSize = strlen(g_PlayerPage) + 1;
    resource.dynData = NULL;
    CHK_OFAIL(har_add_resource(newResources, &resource));

    strcpy(resource.name, "/resources/play.png");
    strcpy(resource.contentType, g_imageContentType);
    resource.data = g_PlayImage;
    resource.dataSize = sizeof(g_PlayImage);
    resource.dynData = NULL;
    CHK_OFAIL(har_add_resource(newResources, &resource));

    strcpy(resource.name, "/resources/stop.png");
    strcpy(resource.contentType, g_imageContentType);
    resource.data = g_StopImage;
    resource.dataSize = sizeof(g_StopImage);
    resource.dynData = NULL;
    CHK_OFAIL(har_add_resource(newResources, &resource));

    strcpy(resource.name, "/resources/pause.png");
    strcpy(resource.contentType, g_imageContentType);
    resource.data = g_PauseImage;
    resource.dataSize = sizeof(g_PauseImage);
    resource.dynData = NULL;
    CHK_OFAIL(har_add_resource(newResources, &resource));

    strcpy(resource.name, "/resources/fastforward.png");
    strcpy(resource.contentType, g_imageContentType);
    resource.data = g_FastForwardImage;
    resource.dataSize = sizeof(g_FastForwardImage);
    resource.dynData = NULL;
    CHK_OFAIL(har_add_resource(newResources, &resource));

    strcpy(resource.name, "/resources/fastrewind.png");
    strcpy(resource.contentType, g_imageContentType);
    resource.data = g_FastRewindImage;
    resource.dataSize = sizeof(g_FastRewindImage);
    resource.dynData = NULL;
    CHK_OFAIL(har_add_resource(newResources, &resource));

    strcpy(resource.name, "/resources/home.png");
    strcpy(resource.contentType, g_imageContentType);
    resource.data = g_HomeImage;
    resource.dataSize = sizeof(g_HomeImage);
    resource.dynData = NULL;
    CHK_OFAIL(har_add_resource(newResources, &resource));

    strcpy(resource.name, "/resources/end.png");
    strcpy(resource.contentType, g_imageContentType);
    resource.data = g_EndImage;
    resource.dataSize = sizeof(g_EndImage);
    resource.dynData = NULL;
    CHK_OFAIL(har_add_resource(newResources, &resource));


    *resources = newResources;
    return 1;

fail:
    har_free_resources(&newResources);
    return 0;
}

void har_free_resources(HTTPAccessResources** resources)
{
    int i;
    if (*resources == NULL)
    {
        return;
    }

    for (i = 0; i < (*resources)->numResources; i++)
    {
        SAFE_FREE(&(*resources)->resources[i].dynData);
    }
    SAFE_FREE(&(*resources)->resources);

    SAFE_FREE(resources);
}

int har_add_resource(HTTPAccessResources* resources, HTTPAccessResource* resource)
{
    HTTPAccessResource* newResources = NULL;
    int i;

    if (resources->numResources + 1 > resources->allocatedResources)
    {
        /* enlarge resource array */

        CALLOC_ORET(newResources, HTTPAccessResource,
            resources->allocatedResources + RESOURCE_ALLOCATION_STEP);
        memcpy(newResources, resources->resources, resources->allocatedResources * sizeof(HTTPAccessResource));

        for (i = 0; i < resources->numResources; i++)
        {
            SAFE_FREE(&resources->resources[i].dynData);
        }
        SAFE_FREE(&resources->resources);

        resources->resources = newResources;
        newResources = NULL;
        resources->allocatedResources += RESOURCE_ALLOCATION_STEP;
    }

    resources->resources[resources->numResources] = *resource;
    resources->numResources++;
    return 1;
}

const HTTPAccessResource* har_get_resource(HTTPAccessResources* resources, const char* name)
{
    int i;

    for (i = 0; i < resources->numResources; i++)
    {
        if (strcmp(resources->resources[i].name, name) == 0)
        {
            return &resources->resources[i];
        }
    }

    return NULL;
}




